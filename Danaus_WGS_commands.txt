#commands for ***

#check queue
qstat -f -u "*"

#1. Genotyping
#2. PCAs
#3. Admixture
#4. Gemma GWAS
#5. genome-wide stats e.g. pi


########
#1. GENOTYPING
########

#raw coverage stats:
#############################################

#make list of scaffolds
cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/scaf.list

#get bams from simon's file: /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_samples.txt
cut -f3 DC174_samples.txt > DC174_bam_names.txt

cp DC174_bam_names.txt DC174_bam_names_full_file_path.txt

#and add the rest of the filepath
sed -i 's/^/\/data\/martin\/genomics\/analyses\/Danaus_mapping\//g' DC174_bam_names_full_file_path.txt

#run mosdepth on these bam files in /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw
touch mosdepth_run.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
echo "mosdepth -n ${bam} /data/martin/genomics/analyses/Danaus_mapping/${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/done_files/${bam}.done" >> mosdepth_run.txt
done

ssh bigshot
mkdir -p /scratch/rdekayne/mosdepth_danaus_DC174/ && cd /scratch/rdekayne/mosdepth_danaus_DC174/

sconda genomics_general

#test
#head -n 1 mosdepth_run.txt > mosdepth_test.txt
#parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigshot -b yes {}' :::: mosdepth_test.txt

#run
parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigshot -b yes {}' :::: mosdepth_run.txt

#if no issues
rm -f mosdepth.*

#extract coverage info
touch bam_raw_coverage.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
grep 'total' /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/${bam}.mosdepth.summary.txt | cut -f4 >> bam_raw_coverage.txt
done

paste /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt bam_raw_coverage.txt > bam_raw_coverage_full.txt

mkdir plot_dist
cd plot_dist/

python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt

scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/plot_dist/dist.html .

cd ../
cp bam_raw_coverage_full.txt bam_raw_coverage_full_plot.txt
sed -i 's/\t/,/g' bam_raw_coverage_full_plot.txt
scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/bam_raw_coverage_full_plot.txt .

#decided to keep all and filter later if necessary

#indel re-alignment:
#############################################

#make conda env for gatk
conda create -n gatk
sconda gatk
conda install -c conda-forge parallel
conda install -c conda-forge openjdk

# bam output dir. /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned

# executible is: /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar

#e.g. https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists

##FULL RUN
cd /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned

touch gatk_indel_realignment_creator_FULL_step1.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -o /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals && touch /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_confirmed/intervals.${bam}.done" >> gatk_indel_realignment_creator_FULL_step1.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_indel_realignment_creator_FULL_step1.txt

#now copy intervals to project folder
cp *.intervals /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/intervals/

#prepare next step - making new bams
rm -f gatk_indel.*

touch gatk_indel_realignment_creator_FULL_step2.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
echo "java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -targetIntervals /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals -o /scratch/rdekayne/gatk/realigned.${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_confirmed/realigned.${bam}.done" >> gatk_indel_realignment_creator_FULL_step2.txt
done

split -l 10 --numeric-suffixes gatk_indel_realignment_creator_FULL_step2.txt gatk_realign

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign00
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign01
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign02
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign03
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign04
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign05
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign06
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign07
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign08
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign09
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign10
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign11
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign12
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign13
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign14
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign15
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign16
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign17

#if you needed to downsample
#sconda genomics_general
#samtools view -s 0.30 -b sample.Dchry2.2.bwa.default.rmdup.bam > sample_downsampled30.Dchry2.2.bwa.default.rmdup.bam
#samtools index sample_downsampled30.Dchry2.2.bwa.default.rmdup.bam

#now to genotyping (biggar)
ssh biggar
mkdir -p /scratch/rdekayne/genotyping && cd /scratch/rdekayne/genotyping

#prepare list of bams
#need to add full filepath
ls /scratch/rdekayne/gatk/*.bam > bam.list

wc -l bam.list
#174

#move to genotpying folder
mkdir -p /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping && cd /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping

sconda genomics_general

touch geno_realigned_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/genotyping/bam.list -r "${line}" | bcftools call -m -f GQ -O v | bgzip > /scratch/rdekayne/genotyping/"${line}".realigned.raw.vcf.gz && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping/done_files/"${line}".realigned.raw.vcf.gz.done" >> geno_realigned_1pop.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=biggar -b yes {}' :::: geno_realigned_1pop.txt

#now move zipped vcfs back to 
mkdir /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs
scp *.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs/

#now make a file listing these vcfs 
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs/
ls *.gz > vcf.list

mkdir /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs

#now filter chromosome vcfs
touch make.filt.chroms.txt
cat /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs/vcf.list | while read line
do
echo "bcftools filter -Oz /scratch/rdekayne/genotyping/"${line}" -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/"${line}"_filt_mindepth7_minqual30.vcf.gz" >> make.filt.chroms.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=biggar -b yes {}' :::: make.filt.chroms.txt

##skip for now
#then make a list
#ls *.vcf.gz > filt_vcf.list

#cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos
##now convert these to .geno format
#touch make.chr.genos.txt
#cat /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/filt_vcf.list | while read line
#do
#echo "python /data/martin/genomics/analyses/Danaus_popgen/Wild90/genomics_general/VCF_processing/parseVCF.py -i /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/"${line}" --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos/"${line}".minQual30.mindp7.maxdp50.geno.gz && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos/"${line}".done" >> make.chr.genos.txt
#done

#parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: make.chr.genos.txt

ssh biggar
sconda genomics_general

#merge into a single file:
ls /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/*.gz > vcf_to_merge.txt

bcftools concat -Ou -f vcf_to_merge.txt | bcftools sort -Oz -o /scratch/rdekayne/genotyping/DC174_allchroms_output_filt_mindepth7_minqual30.vcf.gz

#max 10% missing filter for SNPs
bcftools filter -Oz ./DC174_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAC < 4 | AN < 313' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz

bcftools view -H DC174_allchroms_output_filt_mindepth7_minqual30.vcf.gz | wc -l
## old 349214931

bcftools view -H DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz | wc -l
## old 11511103

#assess missing data %s across individuals

vcftools --gzvcf DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz --missing-indv --out missing_AN313

#if more than 20% missing
awk '{if($5 >= 0.2){print}}' missing_AN313.imiss > missing_AN313_rejected_indivs.txt


########
#2. PCAs
########

mkdir -p /scratch/rdekayne/PCAs && cd /scratch/rdekayne/PCAs

zcat ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz | bgzip -c > ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.b.vcf.gz && tabix ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.b.vcf.gz

#remove small contigs
grep "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > small_scafs.txt

awk '{print $1, $2}' small_scafs.txt | sed 's/ /\t0\t/g' > small_scafs_remove.txt

cd ../genotyping
bcftools view DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.b.vcf.gz -T ^small_scafs_remove.txt -Oz > DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs.b.vcf.gz

#############
#1. full genome excluding chr 15

grep "contig15.1" /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > chr15_info.txt

awk '{print $1, $2}' chr15_info.txt | sed 's/ /\t0\t/g' > chr15_info_remove.txt

#filter out chr15
bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15.b.vcf.gz

#make filtered PCAs
sconda PCA
./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15.b.vcf.gz 1_all

#6778071 variants and 174 people pass filters and QC.
#14575888 variants and 174 people pass filters and QC.

#############
#2. all chr15

#only keep chr15
bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz 2_chr15

#201439 variants and 174 people pass filters and QC.
#626148 variants and 174 people pass filters and QC.

#############
#3. chr15 no SVs 

cp /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/Dchry2.2_region_coordinates.tsv .
sed -i 's/chr15/contig15.1/g' Dchry2.2_region_coordinates.tsv

#now want to just keep columns 1,5,6,8

awk '{print $1,$5,$6,$8}' Dchry2.2_region_coordinates.tsv | tail -n +2 > Dchry2.2_region_coordinates_simple.bed

awk '{print $1}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > chr.txt
awk '{print $2}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > start.txt
awk '{print $3}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > end.txt

paste -d '\t' chr.txt start.txt > chr_start.txt
paste -d '\t' chr_start.txt end.txt > targets.txt 

wc -l targets.txt
#28 targets.txt

bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz -T ^targets.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_nosvs.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_nosvs.b.vcf.gz 3_chr15

#180965 variants and 174 people pass filters and QC.
#506250 variants and 174 people pass filters and QC.

#############
#4. chr15 region 1 - contig15.1	4035981	6220875

echo "contig15.1 4035981 6220875" > region1.txt
sed -i 's/ /\t/g' region1.txt

bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz -T region1.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region1.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region1.b.vcf.gz 4_chr15

#18982 variants and 174 people pass filters and QC.
#88966 variants and 174 people pass filters and QC.

#############
#5. chr15 region 2 - contig15.1 6251636-7829094

echo "contig15.1 6251636 7829094" > region2.txt
sed -i 's/ /\t/g' region2.txt

bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz -T region2.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region2.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region2.b.vcf.gz 5_chr15

#9454 variants and 174 people pass filters and QC.
#56662 variants and 174 people pass filters and QC.

#############
#6. chr15 region 4 - contig15.1 14803486-15299732

echo "contig15.1 14803486 15299732" > region4.txt
sed -i 's/ /\t/g' region4.txt

bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz  -T region4.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region4.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region4.b.vcf.gz 6_chr15

#3980 variants and 174 people pass filters and QC.
#28375 variants and 174 people pass filters and QC.

#############
#7. chr15 region 3

awk -F' ' '{if ($4=="3") print $0}' Dchry2.2_region_coordinates_simple.bed > region3.bed

awk '{print $1}' region3.bed | tail -n +2 > region3_chr.txt
awk '{print $2}' region3.bed | tail -n +2 > region3_start.txt
awk '{print $3}' region3.bed | tail -n +2 > region3_end.txt

paste -d '\t' region3_chr.txt region3_start.txt > region3_chr_start.txt
paste -d '\t' region3_chr_start.txt region3_end.txt > region3_targets.txt 

bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz -T region3_targets.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region3.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region3.b.vcf.gz 7_chr15

#7015 variants and 174 people pass filters and QC.
#34518 variants and 174 people pass filters and QC.

#############
#8. chr15 region 1.1 - contig15.1	4035981	5322257

echo "contig15.1 4035981 5322257" > region1.1.txt
sed -i 's/ /\t/g' region1.1.txt

bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz -T region1.1.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region1.1.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region1.1.b.vcf.gz 8_chr15

#13922 variants and 174 people pass filters and QC.
#56408 variants and 174 people pass filters and QC.

#############
#9. chr15 region 1.2 - contig15.1	5323805	6220875

echo "contig15.1 5323805 6220875" > region1.2.txt
sed -i 's/ /\t/g' region1.2.txt

bcftools view ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz -T region1.2.txt -Oz > ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region1.2.b.vcf.gz

./make_pca.sh ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_region1.2.b.vcf.gz 9_chr15

#5061 variants and 174 people pass filters and QC.
#32553 variants and 174 people pass filters and QC.

#now move everything
mv * /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA 

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/*.eigen* /Users/rishide-kayne/Dropbox/RishiMac2/Danaus/DC174/PCAs/

########
#3. Admixture
########

conda create -n admixture
sconda admixture
conda install -c bioconda admixture

sconda PCA

grep -v "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai | cut -f1 > all_scafs_info.txt

awk '{print $0 "\t" NR }' all_scafs_info.txt | sed 's/\t/\tchr/g' > rename_file.txt

bcftools annotate --rename-chrs rename_file.txt ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15.b.vcf.gz | bgzip > ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed.b.vcf.gz

VCF_FILE=DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed.b.vcf.gz
plink --vcf ../genotyping/$VCF_FILE --double-id --allow-extra-chr --autosome-num 41 \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out admix_in

#Pruning complete.  7797817 of 14575888 variants removed.

# prune and create pca
plink --vcf ../genotyping/$VCF_FILE --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# \
--extract admix_in.prune.in \
--make-bed --pca --out admix_in

#6778071 variants and 174 samples pass filters and QC.

cp admix_in* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/

cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture
touch admixture_run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/admix_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}_admix_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/log${K}_admix_in.out.done" >> admixture_run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: admixture_run.txt

#get error
grep "CV error" *.o*

admixture.o112739:CV error (K=2): 0.34371
admixture.o112740:CV error (K=3): 0.37561
admixture.o112741:CV error (K=4): 0.40693
admixture.o112742:CV error (K=5): 0.43730
admixture.o112743:CV error (K=6): 0.46678
admixture.o112744:CV error (K=7): 0.49150
admixture.o112745:CV error (K=8): 0.51295
admixture.o112746:CV error (K=9): 0.54762
admixture.o112747:CV error (K=10): 0.57907
admixture.o112748:CV error (K=11): 0.61485
admixture.o112749:CV error (K=12): 0.65982

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/*.Q .


#################
##now for chr15
bcftools annotate --rename-chrs rename_file.txt ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz | bgzip > ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_renamed.b.vcf.gz

VCF_FILE=DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_renamed.b.vcf.gz

# prune and create pca
plink --vcf ../genotyping/$VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_in

#626148 variants and 174 samples pass filters and QC.

cp admix_chr15_in* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/

mkdir /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15
touch admixture_chr15.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/admix_chr15_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}_admix_chr15_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15/log${K}_admix_chr15_in.out.done" >> admixture_chr15.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: admixture_chr15.run.txt

grep "CV" *chr15_in.out
log10_admix_chr15_in.out:CV error (K=10): 0.22718
log11_admix_chr15_in.out:CV error (K=11): 0.24660
log12_admix_chr15_in.out:CV error (K=12): 0.24211
log2_admix_chr15_in.out:CV error (K=2): 0.23276
log3_admix_chr15_in.out:CV error (K=3): 0.23117
log4_admix_chr15_in.out:CV error (K=4): 0.21715
log5_admix_chr15_in.out:CV error (K=5): 0.21292
log6_admix_chr15_in.out:CV error (K=6): 0.21605
log7_admix_chr15_in.out:CV error (K=7): 0.22601
log8_admix_chr15_in.out:CV error (K=8): 0.22494
log9_admix_chr15_in.out:CV error (K=9): 0.22462


scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15/*.Q .


###########
#now just sv regions
touch SV_regions.txt
echo "contig15.1 4035981 5322257" >> SV_regions.txt
echo "contig15.1 5323805 6220875" >> SV_regions.txt
echo "contig15.1 6251636 7829094" >> SV_regions.txt
echo "contig15.1 14803486 15299732" >> SV_regions.txt
sed -i 's/ /\t/g' SV_regions.txt

bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T SV_regions.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions.b.vcf.gz

bcftools annotate --rename-chrs rename_file.txt Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_SVs_in

#141862 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15_SVs
touch admixture_chr15_SVs.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_SVs_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_SVs_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15_SVs/log${K}admix_chr15_SVs_in.out.done" >> admixture_chr15_SVs.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_SVs.run.txt

grep "CV error" *.o*

###########
#now just region1.1

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_1.1_in

#44062 variants and 90 samples pass filters and QC.

/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_1
touch admixture_chr15_1_1.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_1.1_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_1.1_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_1/log${K}admix_chr15_1.1_in.out.done" >> admixture_chr15_1_1.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_1_1.run.txt

grep "CV error" *.o*
admixture.o112822:CV error (K=2): 0.27112
admixture.o112823:CV error (K=3): 0.26009
admixture.o112824:CV error (K=4): 0.24243
admixture.o112825:CV error (K=5): 0.23631
admixture.o112826:CV error (K=6): 0.23711
admixture.o112827:CV error (K=7): 0.23773
admixture.o112828:CV error (K=8): 0.25986
admixture.o112829:CV error (K=9): 0.26922
admixture.o112830:CV error (K=10): 0.28153
admixture.o112831:CV error (K=11): 0.29048
admixture.o112832:CV error (K=12): 0.32202

###########
#now just region1.2

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_1.2_in

#27417 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_2
touch admixture_chr15_1_2.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_1.2_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_1.2_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_2/log${K}admix_chr15_1.2_in.out.done" >> admixture_chr15_1_2.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_1_2.run.txt

grep "CV error" *.o*
admixture.o112833:CV error (K=2): 0.27599
admixture.o112834:CV error (K=3): 0.18538
admixture.o112835:CV error (K=4): 0.15799
admixture.o112836:CV error (K=5): 0.12770
admixture.o112837:CV error (K=6): 0.11967
admixture.o112838:CV error (K=7): 0.11794
admixture.o112839:CV error (K=8): 0.12679
admixture.o112840:CV error (K=9): 0.12508
admixture.o112841:CV error (K=10): 0.13903
admixture.o112842:CV error (K=11): 0.14252
admixture.o112843:CV error (K=12): 0.14602

###########
#now just region2

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_2_in

#47470 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region2
touch admixture_chr15_2.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_2_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_2_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region2/log${K}admix_chr15_2_in.out.done" >> admixture_chr15_2.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_2.run.txt

grep "CV error" *.o*
admixture.o112844:CV error (K=2): 0.30578
admixture.o112845:CV error (K=3): 0.21263
admixture.o112846:CV error (K=4): 0.17768
admixture.o112847:CV error (K=5): 0.16711
admixture.o112848:CV error (K=6): 0.14204
admixture.o112849:CV error (K=7): 0.14709
admixture.o112850:CV error (K=8): 0.14127
admixture.o112851:CV error (K=9): 0.15247
admixture.o112852:CV error (K=10): 0.15464
admixture.o112853:CV error (K=11): 0.15580
admixture.o112854:CV error (K=12): 0.16153

###########
#now just region4

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_4_in

#22913 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region4
touch admixture_chr15_4.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_4_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_4_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region4/log${K}admix_chr15_4_in.out.done" >> admixture_chr15_4.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_4.run.txt

grep "CV error" *.o*
admixture.o112855:CV error (K=2): 0.32323
admixture.o112856:CV error (K=3): 0.29803
admixture.o112857:CV error (K=4): 0.28747
admixture.o112858:CV error (K=5): 0.26698
admixture.o112859:CV error (K=6): 0.26972
admixture.o112860:CV error (K=7): 0.27037
admixture.o112861:CV error (K=8): 0.26194
admixture.o112862:CV error (K=9): 0.27706
admixture.o112863:CV error (K=10): 0.28213
admixture.o112864:CV error (K=11): 0.29393
admixture.o112865:CV error (K=12): 0.30239


########
#4. Gemma - GWAS
########

#install GEMMA
conda create -n gemma
sconda gemma
conda install -c bioconda gemma
conda install -c conda-forge parallel

#./gemma -bfile [prefix] -gk [num] -o [prefix]

#-gk [num] - relatedness matrix to estimate, “-gk 1” calculates the centered relatedness matrix while “-gk 2” calculates the standardized relatedness matrix
#-bfile [prefix] - specifies PLINK binary ped file prefix
#-o [prefix] - specifies output file prefix

#need to make PLINK ped file first

#now we want file for relatedness matrix: ssh biggar 
mkdir -p /scratch/rdekayne/gemma && cd /scratch/rdekayne/gemma

#prepare inputs 

mkdir background
mkdir white
mkdir forewing
mkdir background_RAW
mkdir white_RAW
mkdir forewing_RAW

#run DC174_make_gemma_input.R
#move output *csv to /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gemma
#sort by first column so that indivs are ordered correctly in pheno files:
sort -k1 background_colour_values.csv > background_colour_values_sorted.csv
sort -k1 forewing_band_values.csv > forewing_band_values_sorted.csv
sort -k1 white_values.csv > white_values_sorted.csv


#two samples are missing phenotypes: SM16K641 and MB18111

#no phenotypes for one indiv so drop it
echo "SM16K641" > exclude_indivs.txt
echo "MB18111" >> exclude_indivs.txt

#make relatedness matrix using genome without chr 15
bcftools view -S ^exclude_indivs.txt -o ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed_excluded.b.vcf ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed.b.vcf.gz

bgzip DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed_excluded.b.vcf

plink --vcf DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed_excluded.b.vcf.gz --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# --make-bed --pca --out relatedness
#14575888 variants and 172 samples pass filters and QC.


#now produce input for actual GWAS
cd /scratch/rdekayne/PCAs
bcftools annotate --rename-chrs rename_file.txt ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs.b.vcf.gz | bgzip > ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_renamed.b.vcf.gz

cd /scratch/rdekayne/gemma
cp ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_renamed.b.vcf.gz .
bcftools view -S ^./exclude_indivs.txt -o ./gemma_input.vcf DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_renamed.b.vcf.gz

bgzip gemma_input.vcf

sconda PCA
plink --vcf gemma_input.vcf.gz --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# --make-bed --pca --out gemma_in
#15202036 variants and 172 samples pass filters and QC.

##REGULAR
######################1. hindwing colour
./run_gemma.sh /scratch/rdekayne/gemma/relatedness /scratch/rdekayne/gemma/gemma_in /scratch/rdekayne/gemma/background_colour_values_sorted.csv /scratch/rdekayne/gemma/background rel_background

######################2. forewing colour
./run_gemma.sh /scratch/rdekayne/gemma/relatedness /scratch/rdekayne/gemma/gemma_in /scratch/rdekayne/gemma/forewing_band_values_sorted.csv /scratch/rdekayne/gemma/forewing rel_forewing

######################3. white hindwing
./run_gemma.sh /scratch/rdekayne/gemma/relatedness /scratch/rdekayne/gemma/gemma_in /scratch/rdekayne/gemma/white_values_sorted.csv /scratch/rdekayne/gemma/white rel_white


######################4. background hindwing colour RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma/gemma_in /scratch/rdekayne/gemma/background_colour_values_sorted.csv /scratch/rdekayne/gemma/background_RAW raw_background

######################5. forewing colour RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma/gemma_in /scratch/rdekayne/gemma/forewing_band_values_sorted.csv /scratch/rdekayne/gemma/forewing_RAW raw_forewing

######################6. white hindwing RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma/gemma_in /scratch/rdekayne/gemma/white_values_sorted.csv /scratch/rdekayne/gemma/white_RAW raw_white


awk '{print $1,$3,$15}' ./background/output/rel_background_background_full.assoc.txt > background.assoc_toplot.txt
awk '{print $1,$3,$15}' ./forewing/output/rel_forewing_background_full.assoc.txt > forewing.assoc_toplot.txt
awk '{print $1,$3,$15}' ./white/output/rel_white_background_full.assoc.txt > white.assoc_toplot.txt

awk '{print $1,$3,$15}' ./background_RAW/output/raw_background.assoc.txt > backgroundRAW.assoc_toplot.txt
awk '{print $1,$3,$15}' ./forewing_RAW/output/raw_forewing.assoc.txt > forewingRAW.assoc_toplot.txt
awk '{print $1,$3,$15}' ./white_RAW/output/raw_white.assoc.txt > whiteRAW.assoc_toplot.txt

cat */*summary* > all_gemma_summaries.txt

cp *_toplot.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gemma/

##BINARY PHENOTYPES
mkdir -p /scratch/rdekayne/gemma/binary && cd /scratch/rdekayne/gemma/binary

mkdir background
mkdir white
mkdir forewing
mkdir background_RAW
mkdir white_RAW
mkdir forewing_RAW

cp ../gemma_in.* .
cp ../relatedness.* .
cp ../*.sh .

cd /scratch/rdekayne/gemma/binary

#background pheno
#previously background was: light = 1, intermediate = 2, dark = 3
#now we want: light = 1, intermediate or dark = 2
cut -f1 ../background_colour_values_sorted.csv > indivs_1.csv
cut -f2 ../background_colour_values_sorted.csv | sed 's/3/2/g' > background_colour_values_sorted_BINARY_pheno.csv
paste indivs_1.csv background_colour_values_sorted_BINARY_pheno.csv > background_colour_values_sorted_BINARY.csv

#forewing pheno
#previously was: absent = 1, partial = 2, present = 3
#now we want: absent = 1, partial and present = 2
cut -f1 ../forewing_band_values_sorted.csv > indivs_2.csv
cut -f2 ../forewing_band_values_sorted.csv | sed 's/3/2/g' > forewing_band_values_sorted_BINARY_pheno.csv
paste indivs_2.csv forewing_band_values_sorted_BINARY_pheno.csv > forewing_band_values_sorted_BINARY.csv

#white pheno
#previously was: absent = 1, partial = 2, present = 3
#now we want: absent = 1, partial and present = 2
cut -f1 ../white_values_sorted.csv > indivs_3.csv
cut -f2 ../white_values_sorted.csv | sed 's/3/2/g' > white_values_sorted_BINARY_pheno.csv
paste indivs_3.csv white_values_sorted_BINARY_pheno.csv > white_values_sorted_BINARY.csv

######################1. hindwing colour binary
./run_gemma.sh /scratch/rdekayne/gemma/binary/relatedness /scratch/rdekayne/gemma/binary/gemma_in /scratch/rdekayne/gemma/binary/background_colour_values_sorted_BINARY.csv /scratch/rdekayne/gemma/binary/background rel_background_bin

######################2. forewing colour binary
./run_gemma.sh /scratch/rdekayne/gemma/binary/relatedness /scratch/rdekayne/gemma/binary/gemma_in /scratch/rdekayne/gemma/binary/forewing_band_values_sorted_BINARY.csv /scratch/rdekayne/gemma/binary/forewing rel_forewing_bin

######################3. white hindwing binary
./run_gemma.sh /scratch/rdekayne/gemma/binary/relatedness /scratch/rdekayne/gemma/binary/gemma_in /scratch/rdekayne/gemma/binary/white_values_sorted_BINARY.csv /scratch/rdekayne/gemma/binary/white rel_white_bin


######################4. background hindwing colour RAW binary
./run_gemma_raw.sh /scratch/rdekayne/gemma/binary/gemma_in /scratch/rdekayne/gemma/binary/background_colour_values_sorted_BINARY.csv /scratch/rdekayne/gemma/binary/background_RAW raw_background_bin

######################5. forewing colour RAW binary
./run_gemma_raw.sh /scratch/rdekayne/gemma/binary/gemma_in /scratch/rdekayne/gemma/binary/forewing_band_values_sorted_BINARY.csv /scratch/rdekayne/gemma/binary/forewing_RAW raw_forewing_bin

######################6. white hindwing RAW binary
./run_gemma_raw.sh /scratch/rdekayne/gemma/binary/gemma_in /scratch/rdekayne/gemma/binary/white_values_sorted_BINARY.csv /scratch/rdekayne/gemma/binary/white_RAW raw_white_bin


awk '{print $1,$3,$15}' ./background/output/rel_background_bin_background_full.assoc.txt > background.bin.assoc_toplot.txt
awk '{print $1,$3,$15}' ./forewing/output/rel_forewing_bin_background_full.assoc.txt > forewing.bin.assoc_toplot.txt
awk '{print $1,$3,$15}' ./white/output/rel_white_bin_background_full.assoc.txt > white.bin.assoc_toplot.txt

awk '{print $1,$3,$15}' ./background_RAW/output/raw_background_bin.assoc.txt > backgroundRAW.bin.assoc_toplot.txt
awk '{print $1,$3,$15}' ./forewing_RAW/output/raw_forewing_bin.assoc.txt > forewingRAW.bin.assoc_toplot.txt
awk '{print $1,$3,$15}' ./white_RAW/output/raw_white_bin.assoc.txt > whiteRAW.bin.assoc_toplot.txt

cat */*summary* > all_gemma_bin_summaries.txt

cp *_toplot.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gemma/

##RWANDA SAMPLES ONLY
#get rwanda sample IDs: 
rwanda_samples.txt

mkdir -p /scratch/rdekayne/gemma/rwanda && cd /scratch/rdekayne/gemma/rwanda

grep -f rwanda_samples.txt /scratch/rdekayne/gemma/background_colour_values_sorted.csv | sort -k1 > ./background_colour_values_sorted_rwanda.csv
grep -f rwanda_samples.txt /scratch/rdekayne/gemma/forewing_band_values_sorted.csv | sort -k1 > ./forewing_band_values_sorted_rwanda.csv
grep -f rwanda_samples.txt /scratch/rdekayne/gemma/white_values_sorted.csv | sort -k1 > ./white_values_sorted_rwanda.csv

cat background_colour_values_sorted_rwanda.csv | cut -f1 > samples_ordered.txt

#make relatedness matrix using genome without chr 15
bcftools view -S samples_ordered.txt -o ./rwanda_samples_nochr15.b.vcf ../DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed_excluded.b.vcf.gz

bgzip rwanda_samples_nochr15.b.vcf

#check there is variation at these snps
VCF_IN=rwanda_samples_nochr15.b.vcf.gz
VCF_OUT=rwanda_samples_nochr15_mac1.b.vcf.gz
# set filters
vcftools --gzvcf $VCF_IN \
--min-alleles 2 --max-alleles 2 \
--mac 1 \
--recode --stdout | gzip -c > \
$VCF_OUT

plink --vcf rwanda_samples_nochr15_mac1.b.vcf.gz --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# --make-bed --pca --out relatedness
#12944278 variants and 51 samples pass filters and QC.


#now produce input for actual GWAS
bcftools view -S samples_ordered.txt -o ./rwanda_samples.b.vcf ../gemma_input.vcf.gz

bgzip rwanda_samples.b.vcf

VCF_IN=rwanda_samples.b.vcf.gz
VCF_OUT=rwanda_samples_mac1.b.vcf.gz
# set filters
vcftools --gzvcf $VCF_IN \
--min-alleles 2 --max-alleles 2 \
--mac 1 \
--recode --stdout | gzip -c > \
$VCF_OUT

sconda PCA
plink --vcf rwanda_samples_mac1.b.vcf.gz --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# --make-bed --pca --out gemma_in
#13504176 variants and 51 samples pass filters and QC.

mkdir background
mkdir white
mkdir forewing
mkdir background_RAW
mkdir white_RAW
mkdir forewing_RAW

cp ../run_gemma.sh .

##REGULAR
######################1. hindwing colour
./run_gemma.sh /scratch/rdekayne/gemma/rwanda/relatedness /scratch/rdekayne/gemma/rwanda/gemma_in /scratch/rdekayne/gemma/rwanda/background_colour_values_sorted_rwanda.csv /scratch/rdekayne/gemma/rwanda/background rel_background_rwanda

######################2. forewing colour
./run_gemma.sh /scratch/rdekayne/gemma/rwanda/relatedness /scratch/rdekayne/gemma/rwanda/gemma_in /scratch/rdekayne/gemma/rwanda/forewing_band_values_sorted_rwanda.csv /scratch/rdekayne/gemma/rwanda/forewing rel_forewing_rwanda

######################3. white hindwing
./run_gemma.sh /scratch/rdekayne/gemma/rwanda/relatedness /scratch/rdekayne/gemma/rwanda/gemma_in /scratch/rdekayne/gemma/rwanda/white_values_sorted_rwanda.csv /scratch/rdekayne/gemma/rwanda/white rel_white_rwanda


######################4. background hindwing colour RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma/rwanda/gemma_in /scratch/rdekayne/gemma/rwanda/background_colour_values_sorted_rwanda.csv /scratch/rdekayne/gemma/rwanda/background_RAW raw_background_rwanda

######################5. forewing colour RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma/rwanda/gemma_in /scratch/rdekayne/gemma/rwanda/forewing_band_values_sorted_rwanda.csv /scratch/rdekayne/gemma/rwanda/forewing_RAW raw_forewing_rwanda

######################6. white hindwing RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma/rwanda/gemma_in /scratch/rdekayne/gemma/rwanda/white_values_sorted_rwanda.csv /scratch/rdekayne/gemma/rwanda/white_RAW raw_white_rwanda


awk '{print $1,$3,$15}' ./background/output/rel_background_rwanda_background_full.assoc.txt > background.assoc_toplot_rwanda.txt
awk '{print $1,$3,$15}' ./forewing/output/rel_forewing_rwanda_background_full.assoc.txt > forewing.assoc_toplot_rwanda.txt
awk '{print $1,$3,$15}' ./white/output/rel_white_rwanda_background_full.assoc.txt > white.assoc_toplot_rwanda.txt

awk '{print $1,$3,$15}' ./background_RAW/output/raw_background_rwanda.assoc.txt > backgroundRAW.assoc_toplot_rwanda.txt
awk '{print $1,$3,$15}' ./forewing_RAW/output/raw_forewing_rwanda.assoc.txt > forewingRAW.assoc_toplot_rwanda.txt
awk '{print $1,$3,$15}' ./white_RAW/output/raw_white_rwanda.assoc.txt > whiteRAW.assoc_toplot_rwanda.txt

cat */*summary* > all_gemma_summaries_rwanda.txt

cp *_toplot_rwanda.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gemma/


########
#5. genome-wide stats e.g. pi
########

#to calculate pi genome-wide across country samples we need to have filtered raw vcfs which include invariant sites
#we will then split these chromosomal vcfs by country

#starting with contig2 as a test

#the filtering we want is:
mindepth7_minqual30_AN313

cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > full_scaf.list
grep -v "contig0" full_scaf.list > scaf.list

touch filt_vcf_and_geno_part1.txt
cat scaf.list | while read contig
do
echo "bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30.vcf.gz -e 'AN < 313' | bcftools sort -Oz -o /scratch/rdekayne/geno/"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.vcf.gz" >> filt_vcf_and_geno_part1.txt
done

head -n1 filt_vcf_and_geno_part1.txt > test.txt
parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.txt


parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 3 -l h=bigbang -b yes {}' :::: filt_vcf_and_geno_part1.txt


touch filt_vcf_and_geno_part2.txt
cat scaf.list | while read contig
do
echo "cd /scratch/rdekayne/geno python /data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/VCF_processing/parseVCF.py -i ./"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o ./"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.geno.gz && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_genos/"${contig}".done" >> filt_vcf_and_geno_part2.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 3 -l h=bigbang -b yes {}' :::: filt_vcf_and_geno_part2.txt


#now calculate pi in a loop
#genomics.py needs to be here:

cp ../genomics_general/genomics.py .

python popgenWindows.py -w 100000 -m 5000 -g input.geno.gz -o test.output.csv.gz -f phased -T 1 -p popA OBGHA0010,OBGHA0205,OBGHA0540,OBGHA0542,IG19G105,IG19G114 -p popB SM19SY01,SM19SY02,SM19SY03,SM19SY05,SM19SY06


/data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/VCF_processing/parseVCF.py -i /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_genos/contig31.1.realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_genos/contig31.1.realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.geno.gz && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_genos/contig31.1.done






































######################
######################
#	STAIRWAYPLOT
######################
######################
#want to have stairwayplot estimates for each population/morph type

python /ceph/users/smitchell/software/genomics_general/freq.py -g /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/geno_files/inversion_filtered_autosomes.geno.gz -t 10 -p StHelena --popsFile /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/div_win/wild90_country.txt | gzip > /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/SH_SFS_P1.done 

python /ceph/users/smitchell/software/genomics_general/sfs.py -i /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz --inputType baseCounts --FSpops StHelena --pref SH_SFS_P2 && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/autosomes.SH_SFS_P2.done

#stairwayplot:
#example blueprint file
#input setting
popid: StHelena # id of the population (no white space)
nseq: 12 # number of sequences
L: 171973603 # total number of observed nucleic sites, including polymorphic and monomorphic
whether_folded: true # whethr the SFS is folded (true or false)
SFS: 	2602817	1612586	1256746	894319	540655	199712 # snp frequency spectrum: number of singleton, number of doubleton, etc. (separated by white space)
#smallest_size_of_SFS_bin_used_for_estimation: 1 # default is 1; to ignore singletons, uncomment this line and change this number to 2
#largest_size_of_SFS_bin_used_for_estimation: 15 # default is nseq/2 for folded SFS
pct_training: 0.67 # percentage of sites for training
nrand: 1 2 3 4 5 6 7 8 9 10 # number of random break points for each try (separated by white space)
project_dir: StHelena_fold # project directory
stairway_plot_dir: stairway_plot_es # directory to the stairway plot files
ninput: 200 # number of input files to be created for each estimation
#random_seed: 6
#output setting
mu: 2e-9 # assumed mutation rate per site per generation
year_per_generation: 0.11 # assumed generation time (in years)
#plot setting
plot_title: St Helena # title of the plot
xrange: 0.1,10000 # Time (1k year) range; format: xmin,xmax; "0,0" for default
yrange: 0,0 # Ne (1k individual) range; format: xmin,xmax; "0,0" for default
xspacing: 2 # X axis spacing
yspacing: 2 # Y axis spacing
fontsize: 12 # Font size

