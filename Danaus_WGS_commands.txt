#commands for ***

#check queue
qstat -f -u "*"

#1. Genotyping



########
#1. GENOTYPING
########

#make list of scaffolds
cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > /data/martin/genomics/analyses/Danaus_mapping/scaf.list

#prepare list of bams
#need to add full filepath
cp Wild100list_90inds_bam.list Wild100list_90inds_full_filepath_bam.list

sed -i 's/^/\/data\/martin\/genomics\/analyses\/Danaus_mapping\//g' Wild100list_90inds_full_filepath_bam.list

#want 2 test sets - start with contig2.1 and the z which is contig1.1

sconda genomics_general

touch geno_test1_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list -r "${line}" | bcftools call -m -f GQ -O u | bgzip > /scratch/rdekayne/genotyping/"${line}".raw1.vcf.gz" >> geno_test1_1pop.txt
done

touch geno_test1_nohwe.txt

#this time we specify -G - to avoid any hwe filtering
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list -r "${line}" | bcftools call -m -f GQ --group-samples -O u | bgzip > /scratch/rdekayne/genotyping/"${line}".raw2.vcf.gz" >> geno_test1_nohwe.txt
done

head -n2 geno_test1_1pop.txt > test.geno_test1_1pop.txt

head -n2 geno_test1_nohwe.txt > test.geno_test1_nohwe.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno_test1_1pop.txt
parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno_test1_nohwe.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: geno_test1_1pop.txt


#now trying re-alignment:

conda create -n gatk
sconda gatk
conda install -c conda-forge parallel
conda install -c conda-forge openjdk


# bam output dir. /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned

#executible is: /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar

#e.g. https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists
#for bam in list want to run:
sed -i -e "s/\r//g" ../Wild100list_90inds_full_filepath_bam.list
sed -i -e "s/\r//g" ../Wild100list_90inds_bam.list

##test set on contig2.1
touch gatk_indel_realignment_creator.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list | while read line
do
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -L contig2.1 -I ${line} -o /scratch/rdekayne/gatk/realigner.intervals.${bam}.contig2.1.intervals" >> gatk_indel_realignment_creator_step1.txt
done
done

head gatk_indel_realignment_creator_step1.txt -n1 > test.gatk.txt
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.gatk.txt

touch gatk_indel_realignment_creator_step2.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list | while read line
do
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -L contig2.1 -I ${line} -targetIntervals /scratch/rdekayne/gatk/realigner.intervals.${bam}.contig2.1.intervals -o /scratch/rdekayne/gatk/realigned.${bam}" >> gatk_indel_realignment_creator_step2.txt
done
done

head gatk_indel_realignment_creator_step2.txt -n1 > test2.gatk.txt
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test2.gatk.txt


####now full
touch gatk_indel_realignment_creator_FULL_step1.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -o /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals" >> gatk_indel_realignment_creator_FULL_step1.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: gatk_indel_realignment_creator_FULL_step1.txt

touch run.last.sample.txt
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/SM17H01.302.200115.Dchry2.2.bwa.default.rmdup.bam_twosets.bam -o /scratch/rdekayne/gatk/realigner.intervals.SM17H01.302.200115.Dchry2.2.bwa.default.rmdup.bam_twosets.bam.intervals" >> run.last.sample.txt
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: run.last.sample.txt

cp *.intervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals

touch gatk_indel_realignment_creator_FULL_step2.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -targetIntervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals/realigner.intervals.${bam}.intervals -o /scratch/rdekayne/gatk/realigned.${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned_confirmed/realigned.${bam}.done" >> gatk_indel_realignment_creator_FULL_step2.txt
done

ssh bigfoot
mkdir -p /scratch/rdekayne/gatk/

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 3 -l h=bigfoot -b yes {}' :::: gatk_indel_realignment_creator_FULL_step2.txt

#now to genotyping (bigfoot)
cd /scratch/rdekayne/genotyping

#prepare list of bams
#need to add full filepath
ls /scratch/rdekayne/gatk/*.bam > bam.list

#want 2 test sets - start with contig2.1 and the z which is contig1.1

sconda genomics_general

touch geno_realigned_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/gatk/bam.list -r "${line}" | bcftools call -m -f GQ -O u | bgzip > /scratch/rdekayne/genotyping/"${line}".realigned.raw.vcf.gz" >> geno_realigned_1pop.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: geno_realigned_1pop.txt

#now merge the chromosome/contig vcfs:
cp /data/martin/genomics/analyses/Danaus_mapping/scaf.list . 
sed -i 's/$/.realigned.raw.vcf.gz/' /scratch/rdekayne/genotyping/scaf.list
mkdir -p /scratch/rdekayne/genotyping/combined_vcf && cd /scratch/rdekayne/genotyping/combined_vcf
bcftools concat -Ou -f /scratch/rdekayne/genotyping/scaf.list | bcftools sort -Oz -o /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output.vcf.gz"

bcftools view -H 96indiv_allchroms_output.vcf.gz | wc -l

touch move_and_delete_scratch_bams.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "rsync /scratch/rdekayne/gatk/realigned.${bam} /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned.${bam} && rm /scratch/rdekayne/gatk/realigned.${bam}" >> move_and_delete_scratch_bams.txt






###Stairplot
#stairplot
qstat -f -u "*"

conda create -n angsd 
sconda angsd
conda install -c bioconda angsd=0.921
conda install -c conda-forge parallel

ls /data/martin/genomics/analyses/Danaus_mapping/SM16S*.Dchry2.2.*.bam > bam.list

cp /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa .
cp /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai .

cut -f1 Dchry2.2.fa.fai | grep -v "contig0." | grep -v "contig15.1" > /data/martin/genomics/analyses/Danaus_popgen/StHelena_project/angsd/chrom.list

cat chrom.list | while read line
do
	echo 'angsd -gl 2 -dosaf 1 -bam /scratch/rdekayne/angsd/bam.list -ref /scratch/rdekayne/angsd/Dchry2.2.fa -anc /scratch/rdekayne/angsd/Dchry2.2.fa -nThreads 1 -r '${line}' -baq 1 -C 50 -minMapQ 1 -P 30 -minQ 20 -out /scratch/rdekayne/angsd/output.'${line}'.baq1MQ1Q20GL2' >> angsd_run.txt
done

parallel -j 1 'qsub -cwd -N angsd -V -pe smp64 1 -l h=bigbang -b yes {}' :::: angsd_run.txt

#grep "Number of sites retained after filtering" *.e* | wc -l
#40

#grep "Number of sites retained after filtering" *.e* | cut -d':' -f3 > lengths.txt
#cat lengths.txt | awk '{SUM+=$1}END{print SUM}'
#310150036

#check output makes sense
realSFS print output.contig13.1.baq1MQ1Q20GL2.saf.idx | head

realSFS cat -outnames mergedALL *.idx

realSFS mergedALL.saf.idx -P 30 -maxIter 100 -bootstrap 20 > output.mergedALL.baq1MQ1Q20GL2.BS20.sfs

realSFS merged.saf.idx -P 60 -maxIter 100 -bootstrap 20 -fold 1 > output.merged.fodlded.baq1MQ1Q20GL2.BS20.sfs

#fold this manually with simon's R function

###OUTPUT
	-> Only read nSites: 0 will therefore prepare next chromosome (or exit)

	-> NB NB output is no longer log probs of the frequency spectrum!
	-> Output is now simply the expected values! 
	-> You can convert to the old format simply with log(norm(x))


###################

touch genotype_run.txt

cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list -r "${line}" | bcftools call -m -f GQ -O u | bcftools filter -e 'FORMAT/DP < 5 | FORMAT/GQ < 20' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bgzip > /scratch/rdekayne/genotyping/"${line}".vcf.gz" >> genotype_run.txt
done

#parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: genotype_run.txt

head -n2 genotype_run.txt > test.geno.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno.txt

head -n2 genotype_run.txt > test.geno.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno.txt


