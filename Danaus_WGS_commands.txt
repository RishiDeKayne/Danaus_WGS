#commands for ***

#check queue
qstat -f -u "*"

#1. Genotyping
#2. PCAs
#3. Gemma GWAS
#4. genome-wide stats e.g. pi
#5. h12


########
#1. GENOTYPING
########

#raw coverage stats:
#############################################

#make list of scaffolds
cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/scaf.list

#get bams from simon's file: /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_samples.txt
cut -f3 DC174_samples.txt > DC174_bam_names.txt

cp DC174_bam_names.txt DC174_bam_names_full_file_path.txt

#and add the rest of the filepath
sed -i 's/^/\/data\/martin\/genomics\/analyses\/Danaus_mapping\//g' DC174_bam_names_full_file_path.txt

#run mosdepth on these bam files in /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw
touch mosdepth_run.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
echo "mosdepth -n ${bam} /data/martin/genomics/analyses/Danaus_mapping/${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/done_files/${bam}.done" >> mosdepth_run.txt
done

ssh bigshot
mkdir -p /scratch/rdekayne/mosdepth_danaus_DC174/ && cd /scratch/rdekayne/mosdepth_danaus_DC174/

sconda genomics_general

#test
#head -n 1 mosdepth_run.txt > mosdepth_test.txt
#parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigshot -b yes {}' :::: mosdepth_test.txt

#run
parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigshot -b yes {}' :::: mosdepth_run.txt

#if no issues
rm -f mosdepth.*

#extract coverage info
touch bam_raw_coverage.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
grep 'total' /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/${bam}.mosdepth.summary.txt | cut -f4 >> bam_raw_coverage.txt
done

paste /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt bam_raw_coverage.txt > bam_raw_coverage_full.txt

mkdir plot_dist
cd plot_dist/

python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt

scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/plot_dist/dist.html .

cd ../
cp bam_raw_coverage_full.txt bam_raw_coverage_full_plot.txt
sed -i 's/\t/,/g' bam_raw_coverage_full_plot.txt
scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/bam_raw_coverage_full_plot.txt .

#decided to keep all and filter later if necessary

#indel re-alignment:
#############################################

#make conda env for gatk
conda create -n gatk
sconda gatk
conda install -c conda-forge parallel
conda install -c conda-forge openjdk

# bam output dir. /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned

# executible is: /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar

#e.g. https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists

##FULL RUN
cd /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned

touch gatk_indel_realignment_creator_FULL_step1.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -o /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals && touch /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_confirmed/intervals.${bam}.done" >> gatk_indel_realignment_creator_FULL_step1.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_indel_realignment_creator_FULL_step1.txt

#now copy intervals to project folder
cp *.intervals /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/intervals/

#prepare next step - making new bams
rm -f gatk_indel.*

touch gatk_indel_realignment_creator_FULL_step2.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/DC174_bam_names.txt | while read bam
do
echo "java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -targetIntervals /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals -o /scratch/rdekayne/gatk/realigned.${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_confirmed/realigned.${bam}.done" >> gatk_indel_realignment_creator_FULL_step2.txt
done

split -l 10 --numeric-suffixes gatk_indel_realignment_creator_FULL_step2.txt gatk_realign

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign00
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign01
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign02
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign03
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign04
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign05
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign06
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign07
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign08
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign09
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign10
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign11
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign12
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign13
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign14
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign15
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign16
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=biggar -b yes {}' :::: gatk_realign17

#if you needed to downsample
#sconda genomics_general
#samtools view -s 0.30 -b sample.Dchry2.2.bwa.default.rmdup.bam > sample_downsampled30.Dchry2.2.bwa.default.rmdup.bam
#samtools index sample_downsampled30.Dchry2.2.bwa.default.rmdup.bam

#now to genotyping (biggar)
ssh biggar
mkdir -p /scratch/rdekayne/genotyping && cd /scratch/rdekayne/genotyping

#prepare list of bams
#need to add full filepath
ls /scratch/rdekayne/gatk/*.bam > bam.list

wc -l bam.list
#174

#move to genotpying folder
mkdir -p /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping && cd /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping

sconda genomics_general

touch geno_realigned_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/genotyping/bam.list -r "${line}" | bcftools call -m -f GQ -O v | bgzip > /scratch/rdekayne/genotyping/"${line}".realigned.raw.vcf.gz && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping/done_files/"${line}".realigned.raw.vcf.gz.done" >> geno_realigned_1pop.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=biggar -b yes {}' :::: geno_realigned_1pop.txt

#now move zipped vcfs back to 
mkdir /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs
scp *.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs/

#now make a file listing these vcfs 
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs/
ls *.gz > vcf.list

mkdir /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs

#now filter chromosome vcfs
touch make.filt.chroms.txt
cat /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs/vcf.list | while read line
do
echo "bcftools filter -Oz /scratch/rdekayne/genotyping/"${line}" -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/"${line}"_filt_mindepth7_minqual30.vcf.gz" >> make.filt.chroms.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=biggar -b yes {}' :::: make.filt.chroms.txt


ssh biggar
sconda genomics_general

#merge into a single file:
ls /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/*.gz > vcf_to_merge.txt

bcftools concat -Ou -f vcf_to_merge.txt | bcftools sort -Oz -o /scratch/rdekayne/genotyping/DC174_allchroms_output_filt_mindepth7_minqual30.vcf.gz

#max 10% missing filter for SNPs
bcftools filter -Oz ./DC174_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAC < 4 | AN < 313' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz

bcftools view -H DC174_allchroms_output_filt_mindepth7_minqual30.vcf.gz | wc -l
## old 349214931

bcftools view -H DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz | wc -l
## old 11511103

#assess missing data %s across individuals

vcftools --gzvcf DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz --missing-indv --out missing_AN313

#if more than 20% missing
awk '{if($5 >= 0.2){print}}' missing_AN313.imiss > missing_AN313_rejected_indivs.txt


#now do genotyping of chr1/congig1.1 with genotyping that is aware of ploidy i.e. females are haploid and males diploid
#after repeat all concat steps

#get sample list from other vcfs 
bcftools query -l contig0.17.realigned.raw.vcf.gz

#then run DC174_get_sample_ploidy.R and move output to /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping
#copy bam.list from biggar to bigshot

sed -i 's/\/scratch\/rdekayne\/gatk\//\/data\/martin\/genomics\/analyses\/Danaus_mapping\/DC174\/realigned\/realigned_bams\//g' bam.list

cd /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping
touch contig1.1_hap_geno.txt
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/genotyping/bam.list -r contig1.1 | bcftools call -m -f GQ --samples-file sample.ploidy.txt -O v | bgzip > /scratch/rdekayne/genotyping/contig1.1.hap.realigned.raw.vcf.gz && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping/contig1.1.hap.realigned.raw.vcf.gz.done" > contig1.1_hap_geno.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigshot -b yes {}' :::: contig1.1_hap_geno.txt

ssh bigshot
scp *.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/raw_chr_vcfs/


bcftools filter -Oz ./contig1.1.hap.realigned.raw.vcf.gz -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30.vcf.gz

#for chr 1 we want to filter with 10% missing data too but this time we need to calculate based on some haploid indivs:
#in total there are 249 alleles meaning 224 = 90% - leave mac the same to account for sequencing error
bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAC < 4 | AN < 224' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30_mac4_AN313.vcf.gz

#on bigshot  
ls /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/*.gz > vcf_to_merge_with_chr1_hap.txt
grep -v "contig1.1" vcf_to_merge_with_chr1_hap.txt > vcf_to_merge_without_chr1_hap_run.txt

#generate concatenated file for PCAs with no chr 1
bcftools concat -Ou -f vcf_to_merge_without_chr1_hap_run.txt | bcftools sort -Oz -o /scratch/rdekayne/genotyping/DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30.vcf.gz

#max 10% missing filter for SNPs
bcftools filter -Oz ./DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAC < 4 | AN < 313' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz

#and generate concatenated file for GWAS/pi estimates with correctly phased chr1
echo "./DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz" > phased_concat.txt
echo "./contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30_mac4_AN224.vcf.gz" >> phased_concat.txt

bcftools concat -Ou -f phased_concat.txt | bcftools sort -Oz -o ./DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224.vcf.gz

#move these to merged vcf folder:
mv DC174_allchroms* /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs

####
#vcftools --gzvcf DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224.vcf.gz --missing-indv --out missing_AN313_AN224

#if more than 20% missing
#awk '{if($5 >= 0.2){print}}' missing_AN313_AN224.imiss > missing_AN313_AN224_bad_indivs.txt


#generate the vcfs we need for further analyses
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs

zcat /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224.vcf.gz | bgzip -c > DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224.b.vcf.gz && tabix DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224.b.vcf.gz

zcat /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313.vcf.gz | bgzip -c > DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313.b.vcf.gz && tabix DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313.b.vcf.gz

#remove small contigs
grep "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > small_scafs.txt

awk '{print $1, $2}' small_scafs.txt | sed 's/ /\t0\t/g' > small_scafs_remove.txt

bcftools view DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224.b.vcf.gz -T ^small_scafs_remove.txt -Oz > DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs.b.vcf.gz

bcftools view DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313.b.vcf.gz -T ^small_scafs_remove.txt -Oz > DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs.b.vcf.gz


#########now filter on the file with NO chr1
######### full genome no chr15
grep "contig15.1" /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > chr15_info.txt

awk '{print $1, $2}' chr15_info.txt | sed 's/ /\t0\t/g' > chr15_info_remove.txt

#filter out chr15
bcftools view DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15.b.vcf.gz

######### just chr15
bcftools view DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz

######### chr15 no SVs
cp /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/Dchry2.2_region_coordinates.tsv .
sed -i 's/chr15/contig15.1/g' Dchry2.2_region_coordinates.tsv

#now want to just keep columns 1,5,6,8

awk '{print $1,$5,$6,$8}' Dchry2.2_region_coordinates.tsv | tail -n +2 > Dchry2.2_region_coordinates_simple.bed

awk '{print $1}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > chr.txt
awk '{print $2}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > start.txt
awk '{print $3}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > end.txt

paste -d '\t' chr.txt start.txt > chr_start.txt
paste -d '\t' chr_start.txt end.txt > targets.txt 

wc -l targets.txt
#28 targets.txt

bcftools view DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz -T ^targets.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_nosvs.b.vcf.gz

######### chr15 REGION 1
echo "contig15.1 4035981 6220875" > region1.txt
sed -i 's/ /\t/g' region1.txt

bcftools view DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz -T region1.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region1.b.vcf.gz

######### chr15 REGION 2
echo "contig15.1 6251636 7829094" > region2.txt
sed -i 's/ /\t/g' region2.txt

bcftools view DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz -T region2.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region2.b.vcf.gz

######### chr15 REGION 4
echo "contig15.1 14803486 15299732" > region4.txt
sed -i 's/ /\t/g' region4.txt

bcftools view DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz  -T region4.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region4.b.vcf.gz

######### chr15 REGION 3
awk -F' ' '{if ($4=="3") print $0}' Dchry2.2_region_coordinates_simple.bed > region3.bed

awk '{print $1}' region3.bed | tail -n +2 > region3_chr.txt
awk '{print $2}' region3.bed | tail -n +2 > region3_start.txt
awk '{print $3}' region3.bed | tail -n +2 > region3_end.txt

paste -d '\t' region3_chr.txt region3_start.txt > region3_chr_start.txt
paste -d '\t' region3_chr_start.txt region3_end.txt > region3_targets.txt 

bcftools view DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz -T region3_targets.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region3.b.vcf.gz

######### chr15 REGION 1.1
echo "contig15.1 4035981 5322257" > region1.1.txt
sed -i 's/ /\t/g' region1.1.txt

bcftools view DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz -T region1.1.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region1.1.b.vcf.gz

######### chr15 REGION 1.2
echo "contig15.1 5323805 6220875" > region1.2.txt
sed -i 's/ /\t/g' region1.2.txt

bcftools view DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz -T region1.2.txt -Oz > DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region1.2.b.vcf.gz

########
#2. PCAs
########

#############
#1. full genome excluding chr 15

#make PCAs
sconda PCA
/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh DC174_allchroms_nochr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15.b.vcf.gz 1_all

#6766785 variants and 174 people pass filters and QC.
#14548985 variants and 174 people pass filters and QC.

#############
#2. all chr15

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz 2_chr15

#201439 variants and 174 people pass filters and QC.
#626148 variants and 174 people pass filters and QC.

#############
#3. chr15 no SVs 

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_nosvs.b.vcf.gz 3_chr15

#180965 variants and 174 people pass filters and QC.
#506250 variants and 174 people pass filters and QC.

#############
#4. chr15 region 1 - contig15.1	4035981	6220875

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region1.b.vcf.gz 4_chr15

#18982 variants and 174 people pass filters and QC.
#88966 variants and 174 people pass filters and QC.

#############
#5. chr15 region 2 - contig15.1 6251636-7829094

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region2.b.vcf.gz 5_chr15

#9454 variants and 174 people pass filters and QC.
#56662 variants and 174 people pass filters and QC.

#############
#6. chr15 region 4 - contig15.1 14803486-15299732

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh  DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region4.b.vcf.gz 6_chr15

#3980 variants and 174 people pass filters and QC.
#28375 variants and 174 people pass filters and QC.

#############
#7. chr15 region 3

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region3.b.vcf.gz 7_chr15

#7015 variants and 174 people pass filters and QC.
#34518 variants and 174 people pass filters and QC.

#############
#8. chr15 region 1.1 - contig15.1	4035981	5322257

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region1.1.b.vcf.gz 8_chr15

#13922 variants and 174 people pass filters and QC.
#56408 variants and 174 people pass filters and QC.

#############
#9. chr15 region 1.2 - contig15.1	5323805	6220875

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh  DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15_region1.2.b.vcf.gz 9_chr15

#5061 variants and 174 people pass filters and QC.
#32553 variants and 174 people pass filters and QC.

#now move everything
mv *.vcf.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs
mv *.list /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs
mv *.tbi /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs

mv *_chr15_*filt* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/
mv *_all_* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/
mv *.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/
mv *.bed /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/


scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/*.eigen* /Users/rishide-kayne/Dropbox/RishiMac2/Danaus/DC174/PCAs_full/

#want to only use sub-saharan africa samples for chr 15
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA

#get list of samples to exclude
bcftools view -S ^./exclude_sub_saharan_indivs.txt -Oz -o /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/chr15_incude_sub_saharan_indivs.vcf.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz

bcftools query -l /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_chr15.b.vcf.gz | wc -l
bcftools query -l /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/chr15_incude_sub_saharan_indivs.vcf.gz  | wc -l

/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/make_pca.sh /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/chr15_incude_sub_saharan_indivs.vcf.gz 10_chr15_sub
#198057 variants and 146 people pass filters and QC.
#626148 variants and 146 people pass filters and QC.

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/PCA/10*.eigen* .

########
#3. GWAS
########

#prepare inputs 

mkdir background
mkdir white
mkdir forewing

mkdir background/output
mkdir forewing/output
mkdir white/output

#run DC174_make_gemma_input.R
#move output *csv to /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas 
#sort by first column so that indivs are ordered correctly in pheno files:
sort -k1 /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/background_colour_values.csv > background_colour_values_sorted.csv
sort -k1 /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/forewing_band_values.csv > forewing_band_values_sorted.csv
sort -k1 /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/white_values.csv > white_values_sorted.csv

#two samples are missing phenotypes: SM16K641 and MB18111

#no phenotypes for two indivs so drop them
echo "SM16K641" > exclude_indivs.txt
echo "MB18111" >> exclude_indivs.txt

#produce input for GWASv (on bigshot) /scratch/rdekayne/gemma_DC174
bcftools annotate --rename-chrs /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs.b.vcf.gz | bgzip > /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs_renamed.b.vcf.gz

bcftools view -S ^./exclude_indivs.txt -Oz -o ./gemma_input.vcf.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs_renamed.b.vcf.gz

sconda PCA
plink --vcf gemma_input.vcf.gz --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# --make-bed --pca --out gemma_in
#15465717 variants and 172 samples pass filters and QC.

sconda gemma
######################4. background hindwing colour RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma_DC174/gemma_in /scratch/rdekayne/gemma_DC174/background_colour_values_sorted.csv /scratch/rdekayne/gemma_DC174/background background

### number of analyzed SNPs         = 10962529

######################5. forewing colour RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma_DC174/gemma_in /scratch/rdekayne/gemma_DC174/forewing_band_values_sorted.csv /scratch/rdekayne/gemma_DC174/forewing forewing

######################6. white hindwing RAW
./run_gemma_raw.sh /scratch/rdekayne/gemma_DC174/gemma_in /scratch/rdekayne/gemma_DC174/white_values_sorted.csv /scratch/rdekayne/gemma_DC174/white white


awk '{print $1,$3,$15}' ./background/output/rel_background_background_full.assoc.txt > background.assoc_toplot.txt
awk '{print $1,$3,$15}' ./forewing/output/rel_forewing_background_full.assoc.txt > forewing.assoc_toplot.txt
awk '{print $1,$3,$15}' ./white/output/rel_white_background_full.assoc.txt > white.assoc_toplot.txt

cat */*summary* > all_gemma_summaries.txt

cp *_toplot.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gemma/

#####plink GWAS:
cd /scratch/rdekayne/gemma_DC174/background
plink --bfile gemma_in --allow-extra-chr --autosome-num 41 --assoc perm --allow-no-sex --missing-genotype N --threads 50
#15465717 variants and 172 samples pass filters and QC.
mv plink* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background

cd /scratch/rdekayne/gemma_DC174/forewing
plink --bfile gemma_in --allow-extra-chr --autosome-num 41 --assoc perm --allow-no-sex --missing-genotype N --threads 50
#15465717 variants and 172 samples pass filters and QC.
mv plink* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing

cd /scratch/rdekayne/gemma_DC174/white
plink --bfile gemma_in --allow-extra-chr --autosome-num 41 --assoc perm --allow-no-sex --missing-genotype N --threads 50
#15465717 variants and 172 samples pass filters and QC.
mv plink* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white

awk '{print $1,$3,$9}' /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background/plink.qassoc > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background/background_plot.txt
awk '{print $1,$3,$9}' /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing/plink.qassoc > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing/forewing_plot.txt
awk '{print $1,$3,$9}' /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white/plink.qassoc > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white/white_plot.txt

#process background
paste /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background/background_plot.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background/plink.qassoc.perm > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background/background_plot_emp.txt

awk '{print $1,$2,$3,$6}' /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background/background_plot_emp.txt > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/background/background_plot_emp_total.txt

#process forewing
paste /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing/forewing_plot.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing/plink.qassoc.perm > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing/forewing_plot_emp.txt

awk '{print $1,$2,$3,$6}' /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing/forewing_plot_emp.txt > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/forewing/forewing_plot_emp_total.txt

#process white
paste /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white/white_plot.txt /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white/plink.qassoc.perm > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white/white_plot_emp.txt

awk '{print $1,$2,$3,$6}' /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white/white_plot_emp.txt > /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/white/white_plot_emp_total.txt

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gwas/plink_assoc/*/*_emp_total.txt .

cd /scratch/rdekayne/gemma_DC174/background
plink --bfile gemma_in --allow-extra-chr --autosome-num 41 --model perm --allow-no-sex --missing-genotype N --threads 50

cd /scratch/rdekayne/gemma_DC174/forewing
plink --bfile gemma_in --allow-extra-chr --autosome-num 41 --model perm --allow-no-sex --missing-genotype N --threads 50

cd /scratch/rdekayne/gemma_DC174/forewing
plink --bfile gemma_in --allow-extra-chr --autosome-num 41 --model perm --allow-no-sex --missing-genotype N --threads 50



########
#4. genome-wide stats e.g. pi
########
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi

#to calculate pi genome-wide across country samples we need to have filtered raw vcfs which include invariant sites
#we will then split these chromosomal vcfs by country
#the filtering we want is:
mindepth7_minqual30_AN313

cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > full_scaf.list
grep -v "contig0" full_scaf.list > scaf.list

touch filt_vcf_and_geno.txt
cat scaf.list | while read contig
do
echo "cd /scratch/rdekayne/geno && bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30.vcf.gz -e 'AN < 313' | bcftools sort -Oz -o ./"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.vcf.gz && python /data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/VCF_processing/parseVCF.py -i ./"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o ./"${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.geno.gz && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_genos/"${contig}".done" >> filt_vcf_and_geno.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 3 -l h=bigbang -b yes {}' :::: filt_vcf_and_geno.txt


####now run chr1.hap

bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/DC174/filt_chr_vcfs/contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30.vcf.gz -e 'AN < 224' | bcftools sort -Oz -o /scratch/rdekayne/geno/contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN224.vcf.gz

python /data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/VCF_processing/parseVCF.py -i ./contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN224.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 --ploidyFile /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping/sample.ploidy.txt -o ./contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN224.geno.gz

#now for analysis
mkdir -p /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi

#now move popsfile made with 'make_popsfile.R' to here

#now calculate pi in a loop
#genomics.py needs to be here:

cp ../genomics_general/genomics.py .

cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > full_scaf.list
grep -v "contig0" full_scaf.list > scaf.list

### colour by cluster:
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/

tail -n +2 scaf.list > scaf.mod.list
touch calculate_pi_regions.txt
cat scaf.mod.list | while read contig
do
echo "cd /scratch/rdekayne/geno && python /data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/popgenWindows.py -w 100000 -m 5000 -g "${contig}".realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN313.geno.gz -o "${contig}".div.regions.output.csv.gz -f phased -T 1 -p crossed -p med -p orientis -p chrysippus -p klugii -p hybrid --popsFile /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/popsfile_region.txt && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/"${contig}".pi.regions.done" >> calculate_pi_regions.txt
done

parallel -j 1 'qsub -cwd -N diversity -V -pe smp64 1 -l h=bigbang -b yes {}' :::: calculate_pi_regions.txt

python /data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/popgenWindows.py -w 100000 -m 5000 -g ./contig1.1.hap.realigned.raw.vcf.gz_filt_mindepth7_minqual30_AN224.geno.gz -o contig1.1.hap.div.regions.output.csv.gz -f phased -T 4 --ploidyFile /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping/sample.ploidy.txt -p crossed -p med -p orientis -p chrysippus -p klugii -p hybrid --popsFile /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/popsfile_region.txt

cp *.div.regions.output.csv.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/output

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/output/*.csv.gz .



########
#5. h12 stats
########
mkdir /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_genos
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_genos

cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > full_scaf.list
grep -v "contig0" full_scaf.list > scaf.list

tail -n +2 scaf.list > scaf.mod.list

touch make_phased_genos.txt
cat scaf.mod.list | while read contig
do
echo "cd /scratch/rdekayne/geno && python /data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/VCF_processing/parseVCF.py -i /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_vcfs/shapeit_chr_vcfs/"${contig}".double.phased.vcf.gz -o "${contig}".double.phased.geno.gz && python /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_genos/genomics_general/popgenWindows.py -g "${contig}".double.phased.geno.gz -f phased -w 200 --windType sites --analysis hapStats --hapDist 0.01 --threads 4 -p crossed -p med -p orientis -p chrysippus -p klugii -p hybrid --popsFile /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/popsfile_region.txt > "${contig}".output.hapStats.csv" >> make_phased_genos.txt
done

parallel -j 1 'qsub -cwd -N diversity -V -pe smp64 1 -l h=bigbang -b yes {}' :::: make_phased_genos.txt

ssh bigbang
cd /scratch/rdekayne/geno

python /data/martin/genomics/analyses/Danaus_popgen/DC174/genomics_general/VCF_processing/parseVCF.py -i /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_vcfs/shapeit_chr_vcfs/contig1.1.hap.double.phased.vcf.gz --ploidyFile /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping/sample.ploidy.txt -o contig1.1.hap.double.phased.geno.gz && python /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_genos/genomics_general/popgenWindows.py -g contig1.1.hap.double.phased.geno.gz -f phased -w 200 --windType sites --analysis hapStats --hapDist 0.01 --threads 4 --ploidyFile /data/martin/genomics/analyses/Danaus_popgen/DC174/genotyping/sample.ploidy.txt -p crossed -p med -p orientis -p chrysippus -p klugii -p hybrid --popsFile /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/popsfile_region.txt > contig1.1.hap.output.hapStats.csv

cp *.double.phased.geno.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_genos
cp *.csv /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/h12


touch h12_500.txt
cat scaf.mod.list | while read contig
do
echo "cd /scratch/rdekayne/geno && python /data/martin/genomics/analyses/Danaus_popgen/DC174/phased_chr_genos/genomics_general/popgenWindows.py -g "${contig}".double.phased.geno.gz -f phased -w 500 --windType sites --analysis hapStats --hapDist 0.01 --threads 4 -p crossed -p med -p orientis -p chrysippus -p klugii -p hybrid --popsFile /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/pi/popsfile_region.txt > "${contig}".output.500.hapStats.csv" >> h12_500.txt
done

parallel -j 1 'qsub -cwd -N diversity -V -pe smp64 1 -l h=bigbang -b yes {}' :::: h12_500.txt

################################################################################
#       D. melanippus genotyping
################################################################################
########Simon requested re-mapping/genotyping
#/data/martin/genomics/analyses/Danaus_mapping/RG28754._.2016.Dchry2.2.bwa.default.rmdup.bam
#in /data/martin/genomics/analyses/Danaus_mapping/DC174/Dmelanippus

ssh biggar
cd /scratch/rdekayne/melanippus

#indel re-alignment:
sconda gatk
# executible is: /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar

java -jar /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/RG28754._.2016.Dchry2.2.bwa.default.rmdup.bam -o ./realigner.intervals.RG28754._.2016.Dchry2.2.bwa.default.rmdup.bam.intervals && touch melanippus.done

cp *.intervals /data/martin/genomics/analyses/Danaus_mapping/DC174/Dmelanippus

java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/DC174/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/RG28754._.2016.Dchry2.2.bwa.default.rmdup.bam -targetIntervals ./realigner.intervals.RG28754._.2016.Dchry2.2.bwa.default.rmdup.bam.intervals -o ./realigned.RG28754._.2016.Dchry2.2.bwa.default.rmdup.bam && touch realigned.melanippus.done

ls *.bam > bam.list
cp bam.list /data/martin/genomics/analyses/Danaus_mapping/DC174/Dmelanippus

sconda genomics_general

touch geno_melan.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/coverage_raw/scaf.list | while read line
do
echo "cd /scratch/rdekayne/melanippus && bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/melanippus/bam.list -r "${line}" | bcftools call -m -f GQ -O v | bgzip > /scratch/rdekayne/melanippus/"${line}".realigned.raw.vcf.gz && touch /data/martin/genomics/analyses/Danaus_mapping/DC174/Dmelanippus/"${line}".realigned.raw.vcf.gz.done" >> geno_melan.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=biggar -b yes {}' :::: geno_melan.txt

ls *.gz > /data/martin/genomics/analyses/Danaus_mapping/DC174/Dmelanippus/vcf.list

touch make.filt.chroms.txt
cat /data/martin/genomics/analyses/Danaus_mapping/DC174/Dmelanippus/vcf.list | while read line
do
echo "cd /scratch/rdekayne/melanippus && bcftools filter -Oz ./"${line}" -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./"${line}"_filt_mindepth7_minqual30.vcf.gz" >> make.filt.chroms.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=biggar -b yes {}' :::: make.filt.chroms.txt

#merge into a single file:
ls *_filt_mindepth7_minqual30.vcf.gz > melan_vcf_to_merge.txt

bcftools concat -Ou -f melan_vcf_to_merge.txt | bcftools sort -Oz -o ./RG28754_allchroms_output_filt_mindepth7_minqual30.vcf.gz






########
#6. gIMble
########
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gimble

git clone https://github.com/DRL/gimble.git
conda create -n gimble python=3.7.12 bedtools bcftools samtools vcflib mosdepth pysam numpy docopt tqdm pandas tabulate zarr scikit-allel parallel matplotlib msprime demes dask numcodecs python-newick nlopt -c conda-forge -c bioconda -y
sconda gimble
sconda /ceph/software/conda_envs/gimble
gimble/gimble --help

#want to run gIMble on focal indivs, 5 for each morph - put in gimble.indiv.list
#orientis = "SM17S01","SM21BE01","SM21TS05","SM21TS33","SM21TS36"
#klugii = "SM15W72","SM15W74","SM19T002","SM19T003","SM19T008"
#chrysippus = "SM16N01","IG19G105","IG19G114","OBGHA0540","OBGHA0542"

#subset overall vcf and then may symlinks to the realigned.bam files for each of these indivs
#using /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs.b.vcf.gz

ssh bigbird
mkdir -p /scratch/rdekayne/gimble && cd /scratch/rdekayne/gimble
sconda genomics_general
bcftools view -S /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gimble/gimble.indiv.list -Oz -o ./DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs_reference_individuals.b.vcf.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/combined_vcfs/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs.b.vcf.gz

gimble/gimble preprocess -h

mkdir -p /scratch/rdekayne/gimble/bams && cd /scratch/rdekayne/gimble/bams

#make symlinks for bam files in bam directory
##ln -s source_file myfile

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM17S01.DSW44989.170724.Dchry2.2.bwa.default.rmdup.bam realigned.SM17S01.DSW44989.170724.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM17S01.DSW44989.170724.Dchry2.2.bwa.default.rmdup.bai realigned.SM17S01.DSW44989.170724.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21BE01.303.220202.Dchry2.2.bwa.default.rmdup.bam realigned.SM21BE01.303.220202.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21BE01.303.220202.Dchry2.2.bwa.default.rmdup.bai realigned.SM21BE01.303.220202.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21TS05.H5CKGDSX5.221107.Dchry2.2.bwa.default.rmdup.bam realigned.SM21TS05.H5CKGDSX5.221107.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21TS05.H5CKGDSX5.221107.Dchry2.2.bwa.default.rmdup.bai realigned.SM21TS05.H5CKGDSX5.221107.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21TS33.309.220202.Dchry2.2.bwa.default.rmdup.bam realigned.SM21TS33.309.220202.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21TS33.309.220202.Dchry2.2.bwa.default.rmdup.bai realigned.SM21TS33.309.220202.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21TS36.EDSW220000311-1a.220215.Dchry2.2.bwa.default.rmdup_2sets.bam realigned.SM21TS36.EDSW220000311-1a.220215.Dchry2.2.bwa.default.rmdup_2sets.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM21TS36.EDSW220000311-1a.220215.Dchry2.2.bwa.default.rmdup_2sets.bai realigned.SM21TS36.EDSW220000311-1a.220215.Dchry2.2.bwa.default.rmdup_2sets.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM15W72.DSW44976.170724.Dchry2.2.bwa.default.rmdup.bam realigned.SM15W72.DSW44976.170724.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM15W72.DSW44976.170724.Dchry2.2.bwa.default.rmdup.bai realigned.SM15W72.DSW44976.170724.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM15W74.DSW31519.170110.Dchry2.2.bwa.default.rmdup.bam realigned.SM15W74.DSW31519.170110.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM15W74.DSW31519.170110.Dchry2.2.bwa.default.rmdup.bai realigned.SM15W74.DSW31519.170110.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM19T002.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bam realigned.SM19T002.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM19T002.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bai realigned.SM19T002.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM19T003.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bam realigned.SM19T003.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM19T003.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bai realigned.SM19T003.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM19T008.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bam realigned.SM19T008.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM19T008.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bai realigned.SM19T008.H5GL5DSX5.221107.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM16N01.DSW44968.220307.Dchry2.2.bwa.default.rmdup.bam realigned.SM16N01.DSW44968.220307.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.SM16N01.DSW44968.220307.Dchry2.2.bwa.default.rmdup.bai realigned.SM16N01.DSW44968.220307.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.IG19G105.H5J5MDSX5.221107.Dchry2.2.bwa.default.rmdup.bam realigned.IG19G105.H5J5MDSX5.221107.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.IG19G105.H5J5MDSX5.221107.Dchry2.2.bwa.default.rmdup.bai realigned.IG19G105.H5J5MDSX5.221107.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.IG19G114.EDSW200000315-1a.220307.Dchry2.2.bwa.default.rmdup.bam realigned.IG19G114.EDSW200000315-1a.220307.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.IG19G114.EDSW200000315-1a.220307.Dchry2.2.bwa.default.rmdup.bai realigned.IG19G114.EDSW200000315-1a.220307.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.OBGHA0540.295.220202.Dchry2.2.bwa.default.rmdup.bam realigned.OBGHA0540.295.220202.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.OBGHA0540.295.220202.Dchry2.2.bwa.default.rmdup.bai realigned.OBGHA0540.295.220202.Dchry2.2.bwa.default.rmdup.bai

ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.OBGHA0542.296.220202.Dchry2.2.bwa.default.rmdup.bam realigned.OBGHA0542.296.220202.Dchry2.2.bwa.default.rmdup.bam
ln -s /data/martin/genomics/analyses/Danaus_mapping/DC174/realigned/realigned_bams/realigned.OBGHA0542.296.220202.Dchry2.2.bwa.default.rmdup.bai realigned.OBGHA0542.296.220202.Dchry2.2.bwa.default.rmdup.bai

bcftools reheader --samples /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gimble/reheader.txt -o ./DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs_reference_individuals_renamed.b.vcf.gz /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gimble/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs_reference_individuals.b.vcf.gz

touch gimble.run
echo "/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/gimble/gimble/gimble preprocess -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -v /scratch/rdekayne/gimble/DC174_allchroms_chr1HAP_output_filt_mindepth7_minqual30_mac4_AN313_AN224_nosmallcontigs_reference_individuals_renamed.b.vcf.gz -b /scratch/rdekayne/gimble/bams/ -g 2 -q 20 -m 8 -M 2 -t 20 -o /scratch/rdekayne/gimble/reference_indivs_gimble/ " > gimble.run

parallel -j 1 'qsub -cwd -N gimble_run -V -pe smp64 20 -l h=bigyin -b yes {}' :::: gimble.run



 























#################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

######################
######################
#	STAIRWAYPLOT
######################
######################
#want to have stairwayplot estimates for each population/morph type

python /ceph/users/smitchell/software/genomics_general/freq.py -g /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/geno_files/inversion_filtered_autosomes.geno.gz -t 10 -p StHelena --popsFile /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/div_win/wild90_country.txt | gzip > /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/SH_SFS_P1.done 

python /ceph/users/smitchell/software/genomics_general/sfs.py -i /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz --inputType baseCounts --FSpops StHelena --pref SH_SFS_P2 && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/autosomes.SH_SFS_P2.done

#stairwayplot:
#example blueprint file
#input setting
popid: StHelena # id of the population (no white space)
nseq: 12 # number of sequences
L: 171973603 # total number of observed nucleic sites, including polymorphic and monomorphic
whether_folded: true # whethr the SFS is folded (true or false)
SFS: 	2602817	1612586	1256746	894319	540655	199712 # snp frequency spectrum: number of singleton, number of doubleton, etc. (separated by white space)
#smallest_size_of_SFS_bin_used_for_estimation: 1 # default is 1; to ignore singletons, uncomment this line and change this number to 2
#largest_size_of_SFS_bin_used_for_estimation: 15 # default is nseq/2 for folded SFS
pct_training: 0.67 # percentage of sites for training
nrand: 1 2 3 4 5 6 7 8 9 10 # number of random break points for each try (separated by white space)
project_dir: StHelena_fold # project directory
stairway_plot_dir: stairway_plot_es # directory to the stairway plot files
ninput: 200 # number of input files to be created for each estimation
#random_seed: 6
#output setting
mu: 2e-9 # assumed mutation rate per site per generation
year_per_generation: 0.11 # assumed generation time (in years)
#plot setting
plot_title: St Helena # title of the plot
xrange: 0.1,10000 # Time (1k year) range; format: xmin,xmax; "0,0" for default
yrange: 0,0 # Ne (1k individual) range; format: xmin,xmax; "0,0" for default
xspacing: 2 # X axis spacing
yspacing: 2 # Y axis spacing
fontsize: 12 # Font size

########
#3. Admixture
########

conda create -n admixture
sconda admixture
conda install -c bioconda admixture

sconda PCA

grep -v "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai | cut -f1 > all_scafs_info.txt

awk '{print $0 "\t" NR }' all_scafs_info.txt | sed 's/\t/\tchr/g' > rename_file.txt

bcftools annotate --rename-chrs rename_file.txt ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15.b.vcf.gz | bgzip > ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed.b.vcf.gz

VCF_FILE=DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_nochr15_renamed.b.vcf.gz
plink --vcf ../genotyping/$VCF_FILE --double-id --allow-extra-chr --autosome-num 41 \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out admix_in

#Pruning complete.  7797817 of 14575888 variants removed.

# prune and create pca
plink --vcf ../genotyping/$VCF_FILE --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# \
--extract admix_in.prune.in \
--make-bed --pca --out admix_in

#6778071 variants and 174 samples pass filters and QC.

cp admix_in* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/

cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture
touch admixture_run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/admix_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}_admix_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/log${K}_admix_in.out.done" >> admixture_run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: admixture_run.txt

#get error
grep "CV error" *.o*

admixture.o112739:CV error (K=2): 0.34371
admixture.o112740:CV error (K=3): 0.37561
admixture.o112741:CV error (K=4): 0.40693
admixture.o112742:CV error (K=5): 0.43730
admixture.o112743:CV error (K=6): 0.46678
admixture.o112744:CV error (K=7): 0.49150
admixture.o112745:CV error (K=8): 0.51295
admixture.o112746:CV error (K=9): 0.54762
admixture.o112747:CV error (K=10): 0.57907
admixture.o112748:CV error (K=11): 0.61485
admixture.o112749:CV error (K=12): 0.65982

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/*.Q .


#################
##now for chr15
bcftools annotate --rename-chrs rename_file.txt ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15.b.vcf.gz | bgzip > ../genotyping/DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_renamed.b.vcf.gz

VCF_FILE=DC174_allchroms_output_filt_mindepth7_minqual30_mac4_AN313_nosmallcontigs_CHR15_renamed.b.vcf.gz

# prune and create pca
plink --vcf ../genotyping/$VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_in

#626148 variants and 174 samples pass filters and QC.

cp admix_chr15_in* /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/

mkdir /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15
cd /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15
touch admixture_chr15.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/admix_chr15_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}_admix_chr15_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15/log${K}_admix_chr15_in.out.done" >> admixture_chr15.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: admixture_chr15.run.txt

grep "CV" *chr15_in.out
log10_admix_chr15_in.out:CV error (K=10): 0.22718
log11_admix_chr15_in.out:CV error (K=11): 0.24660
log12_admix_chr15_in.out:CV error (K=12): 0.24211
log2_admix_chr15_in.out:CV error (K=2): 0.23276
log3_admix_chr15_in.out:CV error (K=3): 0.23117
log4_admix_chr15_in.out:CV error (K=4): 0.21715
log5_admix_chr15_in.out:CV error (K=5): 0.21292
log6_admix_chr15_in.out:CV error (K=6): 0.21605
log7_admix_chr15_in.out:CV error (K=7): 0.22601
log8_admix_chr15_in.out:CV error (K=8): 0.22494
log9_admix_chr15_in.out:CV error (K=9): 0.22462


scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/DC174/analysis/admixture/chr15/*.Q .


###########
#now just sv regions
touch SV_regions.txt
echo "contig15.1 4035981 5322257" >> SV_regions.txt
echo "contig15.1 5323805 6220875" >> SV_regions.txt
echo "contig15.1 6251636 7829094" >> SV_regions.txt
echo "contig15.1 14803486 15299732" >> SV_regions.txt
sed -i 's/ /\t/g' SV_regions.txt

bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T SV_regions.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions.b.vcf.gz

bcftools annotate --rename-chrs rename_file.txt Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_SVs_in

#141862 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15_SVs
touch admixture_chr15_SVs.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_SVs_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_SVs_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15_SVs/log${K}admix_chr15_SVs_in.out.done" >> admixture_chr15_SVs.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_SVs.run.txt

grep "CV error" *.o*

###########
#now just region1.1

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_1.1_in

#44062 variants and 90 samples pass filters and QC.

/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_1
touch admixture_chr15_1_1.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_1.1_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_1.1_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_1/log${K}admix_chr15_1.1_in.out.done" >> admixture_chr15_1_1.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_1_1.run.txt

grep "CV error" *.o*
admixture.o112822:CV error (K=2): 0.27112
admixture.o112823:CV error (K=3): 0.26009
admixture.o112824:CV error (K=4): 0.24243
admixture.o112825:CV error (K=5): 0.23631
admixture.o112826:CV error (K=6): 0.23711
admixture.o112827:CV error (K=7): 0.23773
admixture.o112828:CV error (K=8): 0.25986
admixture.o112829:CV error (K=9): 0.26922
admixture.o112830:CV error (K=10): 0.28153
admixture.o112831:CV error (K=11): 0.29048
admixture.o112832:CV error (K=12): 0.32202

###########
#now just region1.2

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_1.2_in

#27417 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_2
touch admixture_chr15_1_2.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_1.2_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_1.2_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_2/log${K}admix_chr15_1.2_in.out.done" >> admixture_chr15_1_2.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_1_2.run.txt

grep "CV error" *.o*
admixture.o112833:CV error (K=2): 0.27599
admixture.o112834:CV error (K=3): 0.18538
admixture.o112835:CV error (K=4): 0.15799
admixture.o112836:CV error (K=5): 0.12770
admixture.o112837:CV error (K=6): 0.11967
admixture.o112838:CV error (K=7): 0.11794
admixture.o112839:CV error (K=8): 0.12679
admixture.o112840:CV error (K=9): 0.12508
admixture.o112841:CV error (K=10): 0.13903
admixture.o112842:CV error (K=11): 0.14252
admixture.o112843:CV error (K=12): 0.14602

###########
#now just region2

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_2_in

#47470 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region2
touch admixture_chr15_2.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_2_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_2_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region2/log${K}admix_chr15_2_in.out.done" >> admixture_chr15_2.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_2.run.txt

grep "CV error" *.o*
admixture.o112844:CV error (K=2): 0.30578
admixture.o112845:CV error (K=3): 0.21263
admixture.o112846:CV error (K=4): 0.17768
admixture.o112847:CV error (K=5): 0.16711
admixture.o112848:CV error (K=6): 0.14204
admixture.o112849:CV error (K=7): 0.14709
admixture.o112850:CV error (K=8): 0.14127
admixture.o112851:CV error (K=9): 0.15247
admixture.o112852:CV error (K=10): 0.15464
admixture.o112853:CV error (K=11): 0.15580
admixture.o112854:CV error (K=12): 0.16153

###########
#now just region4

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_4_in

#22913 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region4
touch admixture_chr15_4.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_4_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_4_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region4/log${K}admix_chr15_4_in.out.done" >> admixture_chr15_4.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_4.run.txt

grep "CV error" *.o*
admixture.o112855:CV error (K=2): 0.32323
admixture.o112856:CV error (K=3): 0.29803
admixture.o112857:CV error (K=4): 0.28747
admixture.o112858:CV error (K=5): 0.26698
admixture.o112859:CV error (K=6): 0.26972
admixture.o112860:CV error (K=7): 0.27037
admixture.o112861:CV error (K=8): 0.26194
admixture.o112862:CV error (K=9): 0.27706
admixture.o112863:CV error (K=10): 0.28213
admixture.o112864:CV error (K=11): 0.29393
admixture.o112865:CV error (K=12): 0.30239


