#commands for ***

#check queue
qstat -f -u "*"

#1. Genotyping



########
#1. GENOTYPING
########

#make list of scaffolds
cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > /data/martin/genomics/analyses/Danaus_mapping/scaf.list

#prepare list of bams
#need to add full filepath
cp Wild100list_90inds_bam.list Wild100list_90inds_full_filepath_bam.list

sed -i 's/^/\/data\/martin\/genomics\/analyses\/Danaus_mapping\//g' Wild100list_90inds_full_filepath_bam.list
sed -i -e "s/\r//g" ./Wild100list_90inds_full_filepath_bam.list
sed -i -e "s/\r//g" ./Wild100list_90inds_bam.list

#############################################
#indel re-alignment:
#############################################

#make conda env for gatk
conda create -n gatk
sconda gatk
conda install -c conda-forge parallel
conda install -c conda-forge openjdk

# bam output dir. /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned

# executible is: /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar

#e.g. https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists

###FULL RUN
cd /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned

touch gatk_indel_realignment_creator_FULL_step1.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -o /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned_confirmed/intervals.${bam}.done" >> gatk_indel_realignment_creator_FULL_step1.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: gatk_indel_realignment_creator_FULL_step1.txt

#now move intervals to project folder
cp *.intervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals

#prepare next step - making new bams
touch gatk_indel_realignment_creator_FULL_step2.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -targetIntervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals/realigner.intervals.${bam}.intervals -o /scratch/rdekayne/gatk/realigned.${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned_confirmed/realigned.${bam}.done" >> gatk_indel_realignment_creator_FULL_step2.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: gatk_indel_realignment_creator_FULL_step2.txt

###assess bams with MOSDEPTH
#/data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth

ssh bigbang
mkdir /scratch/rdekayne/mosdepth_danaus/
cd /scratch/rdekayne/gatk

ls *.bam > /scratch/rdekayne/mosdepth_danaus/bam_nofilepath.list

touch mosdepth_run.txt
cat /scratch/rdekayne/mosdepth_danaus/bam_nofilepath.list | while read bam
do
echo "mosdepth -n ${bam} /scratch/rdekayne/gatk/${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/done_files/${bam}.done" >> mosdepth_run.txt
done

cp mosdepth_run.txt /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth

sconda genomics_general
parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigbang -b yes {}' :::: mosdepth_run.txt

mkdir plot_dist
cd plot_dist/

python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt

scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/plot_dist/dist.html .

grep "total" ../realigned.SM18W01.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam.mosdepth.summary.txt
#total   354020300       34859745395     98.47   0       22276

mkdir low_high_indivs
mv ../*SM18W01* low_high_indivs

#before genotyping want to downsample SM18W01 and move SM17H06 to rejected folder due to low coverage
ssh bigbang
cd /scratch/rdekayne/gatk/

sconda genomics_general
samtools view -s 0.30 -b realigned.SM18W01.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam > realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam

samtools index realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam

#now move old bam into rejected_indivs
mv realigned.SM18W01.UKDSW02200* rejected_individuals

#this leaves 90 individuals - 89 original and new subsampled SM18W01

#run mosdepth on this one sample - in /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth
echo "mosdepth -n realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam /scratch/rdekayne/gatk/realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam" > subsampled_mosdepth.txt

parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigbang -b yes {}' :::: subsampled_mosdepth.txt

#run mosdepth plot again for all 89 individuals
cd /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/plot_dist
python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt -o 90_inc_downsampled_dist.html
#and download

#now to genotyping (bigfoot)
ssh bigbang
mkdir -p /scratch/rdekayne/genotyping && cd /scratch/rdekayne/genotyping

#prepare list of bams
#need to add full filepath
ls /scratch/rdekayne/gatk/*.bam > bam.list

wc -l bam.list
#90

sconda genomics_general

touch geno_realigned_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/genotyping/bam.list -r "${line}" | bcftools call -m -f GQ -O v | bgzip > /scratch/rdekayne/genotyping/"${line}".realigned.raw.vcf.gz && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/genotyping/done_files/"${line}".realigned.raw.vcf.gz.done" >> geno_realigned_1pop.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: geno_realigned_1pop.txt

#now move zipped vcfs back to 
mkdir /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs
scp *.gz /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/

#now make a file listing these vcfs 
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/
ls *.gz > vcf.list

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs

#now filter chromosome vcfs
touch make.filt.chroms.txt
cat /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/vcf.list | while read line
do
echo "bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/"${line}" -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/"${line}"_filt_mindepth7_minqual30.vcf.gz" >> make.filt.chroms.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: make.filt.chroms.txt

then make a list
ls *.vcf.gz > filt_vcf.list

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos
#now convert these to .geno format
touch make.chr.genos.txt
cat /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/filt_vcf.list | while read line
do
echo "python /data/martin/genomics/analyses/Danaus_popgen/Wild90/genomics_general/VCF_processing/parseVCF.py -i /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/"${line}" --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos/"${line}".minQual30.mindp7.maxdp50.geno.gz && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos/"${line}".done" >> make.chr.genos.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: make.chr.genos.txt

#merge into a single file:
ls /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/*.gz > vcf_to_merge.txt

bcftools concat -Ou -f vcf_to_merge.txt | bcftools sort -Oz -o /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz

bcftools filter -Oz ./Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAF > 0.05 | AN < 180' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz

bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz | wc -l
#349214931
bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz | wc -l
#12963087

#make excl_list.txt listing individuals to get rid of:
SM17H01
SM17H02
SM17H03
SM17H04
SM17H05
SM17H07
AB19401

bcftools view -S ^excl_list.txt -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf

gzip Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf

######################
######################
#	PCAS
######################
######################

#using no missing data for PCAs in total = 
#all run with st helena + AB19401 and then without
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA

zcat Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz | bgzip -c > Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz && tabix Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz

zcat Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz | bgzip -c > Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz && tabix Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz

ssh bigbang
cd /scratch/rdekayne/genotyping/combined_vcf

cp /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz .
cp /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz .

#remove small contigs
grep "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > small_scafs.txt

awk '{print $1, $2}' small_scafs.txt | sed 's/ /\t0\t/g' > small_scafs_remove.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz -T ^small_scafs_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz -T ^small_scafs_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs.b.vcf.gz

#############
#1. full genome excluding chr 15

grep "contig15.1" /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > chr15_info.txt

awk '{print $1, $2}' chr15_info.txt | sed 's/ /\t0\t/g' > chr15_info_remove.txt

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz


sconda PCA
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 1_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 1_all_filt_noout.prune.in --make-bed --pca --out 1_all_filt_noout
#4735421 variants and 90 people pass filters and QC.


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 1_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 1_dropped_filt_noout.prune.in --make-bed --pca --out 1_dropped_filt_noout
#4639957 variants and 83 people pass filters and QC.


cp *_filt_noout.eigenval 90_filt_noout.eigenvec /data/martin/genomics/analyses/Danaus_popgen/Wild90/analyses/PCAs

#############
#2. all chr15

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 2_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 2_chr15_all_filt_noout.prune.in --make-bed --pca --out 2_chr15_all_filt_noout
#152527 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 2_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 2_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 2_chr15_dropped_filt_noout
#149224 variants and 83 people pass filters and QC.

#for the next set use: Dchry2.2_region_coordinates.tsv
#############
#3. chr15 no SVs 

sed -i 's/chr15/contig15.1/g' Dchry2.2_region_coordinates.tsv

#now want to just keep columns 1,5,6,8

awk '{print $1,$5,$6,$8}' Dchry2.2_region_coordinates.tsv | tail -n +2 > Dchry2.2_region_coordinates_simple.bed

awk '{print $1}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > chr.txt
awk '{print $2}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > start.txt
awk '{print $3}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > end.txt

paste -d '\t' chr.txt start.txt > chr_start.txt
paste -d '\t' chr_start.txt end.txt > targets.txt 

wc -l targets.txt
#28 targets.txt

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T ^targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_nosvs.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T ^targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 3_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 3_chr15_all_filt_noout.prune.in --make-bed --pca --out 3_chr15_all_filt_noout
#131727 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 3_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 3_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 3_chr15_dropped_filt_noout
#128865 variants and 83 people pass filters and QC.

#############
#4. chr15 region 1 - contig15.1	4035981	6220875

echo "contig15.1 4035981 6220875" > region1.txt
sed -i 's/ /\t/g' region1.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 4_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 4_chr15_all_filt_noout.prune.in --make-bed --pca --out 4_chr15_all_filt_noout
#22206 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 4_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 4_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 4_chr15_dropped_filt_noout
#21633 variants and 83 people pass filters and QC.

#############
#5. chr15 region 2 - contig15.1 6251636-7829094

echo "contig15.1 6251636 7829094" > region2.txt
sed -i 's/ /\t/g' region2.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region2.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 5_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 5_chr15_all_filt_noout.prune.in --make-bed --pca --out 5_chr15_all_filt_noout
#10138 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 5_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 5_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 5_chr15_dropped_filt_noout
#9924 variants and 83 people pass filters and QC.

#############
#6. chr15 region 4 - contig15.1 14803486-15299732

echo "contig15.1 14803486 15299732" > region4.txt
sed -i 's/ /\t/g' region4.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region4.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region4.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region4.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 6_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 6_chr15_all_filt_noout.prune.in --make-bed --pca --out 6_chr15_all_filt_noout
#6072 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 6_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 6_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 6_chr15_dropped_filt_noout
#5959 variants and 83 people pass filters and QC.

#############
#7. chr15 region 3

awk -F' ' '{if ($4=="3") print $0}' Dchry2.2_region_coordinates_simple.bed > region3.bed

awk '{print $1}' region3.bed | tail -n +2 > region3_chr.txt
awk '{print $2}' region3.bed | tail -n +2 > region3_start.txt
awk '{print $3}' region3.bed | tail -n +2 > region3_end.txt

paste -d '\t' region3_chr.txt region3_start.txt > region3_chr_start.txt
paste -d '\t' region3_chr_start.txt region3_end.txt > region3_targets.txt 


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region3_targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region3.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region3_targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 7_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 7_chr15_all_filt_noout.prune.in --make-bed --pca --out 7_chr15_all_filt_noout
#4559 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 7_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 7_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 7_chr15_dropped_filt_noout
#4470 variants and 83 people pass filters and QC.


#now move everything
mv * /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA 
mv *.vcf.gz ../../merged_vcfs/
mv *.tbi ../../merged_vcfs/

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/*.eigen* /Users/rishide-kayne/Dropbox/RishiMac2/Danaus/Wild90/PCAs/

#############
#8. chr15 region 1.1 - contig15.1	4035981	5322257

echo "contig15.1 4035981 5322257" > region1.1.txt
sed -i 's/ /\t/g' region1.1.txt


bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region1.1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.1.b.vcf.gz

bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 8_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 8_chr15_all_filt_noout.prune.in --make-bed --pca --out 8_chr15_all_filt_noout
#16519 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 8_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 8_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 8_chr15_dropped_filt_noout
#16091 variants and 83 people pass filters and QC.

#############
#9. chr15 region 1.1 - contig15.1	5323805	6220875

echo "contig15.1 5323805 6220875" > region1.2.txt
sed -i 's/ /\t/g' region1.2.txt


bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region1.2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.2.b.vcf.gz

bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 9_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 9_chr15_all_filt_noout.prune.in --make-bed --pca --out 9_chr15_all_filt_noout
#5695 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 9_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 9_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 9_chr15_dropped_filt_noout
#5541 variants and 83 people pass filters and QC.

mv * /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA 
mv *.vcf.gz ../../merged_vcfs/

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/*.eigen* .

######################
######################
#	ADMIXTURE
######################
######################

#admixture
conda create -n admixture
sconda admixture
conda install -c bioconda admixture

mkdir -p /scratch/rdekayne/genotyping/popgen/admixture && cd /scratch/rdekayne/genotyping/popgen/admixture
sconda PCA

grep -v "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai | cut -f1 > all_scafs_info.txt

awk '{print $0 "\t" NR }' all_scafs_info.txt | sed 's/\t/\tchr/g' > rename_file.txt

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15_renamed.b.vcf.gz
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 41 \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out admix_in

Pruning complete.  7716241 of 12451662 variants removed.


# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# \
--extract admix_in.prune.in \
--make-bed --pca --out admix_in

#4735421 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture
touch admixture_run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/genotyping/popgen/admixture/admix_in.bed ${K} | tee /scratch/rdekayne/genotyping/popgen/admixture/log${K}_admix_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/log${K}_admix_in.out.done" >> admixture_run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigbang -b yes {}' :::: admixture_run.txt



######################
######################
#	SPLITSTREE
######################
######################

##splitstree
bcftools +prune -l 0.2 -w 10000 /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz -Oz -o Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.vcf.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i /scratch/rdekayne/genotyping/popgen/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=5 max=50 -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.geno.gz

python /ceph/users/smartin/Research/genomics_general/distMat.py -g Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.geno.gz -f phased --windType cat -o Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.dist


######################
######################
#	WHATSHAP
######################
######################

#whatshap for phasing of wild90 dataset

#we want the vcf to have max 10% missing data and biallelic snps






######################
######################
#	RAXML
######################
######################


######################
######################
#	STAIRWAYPLOT
######################
######################
#want to have stairwayplot estimates for each population/morph type

python /ceph/users/smitchell/software/genomics_general/freq.py -g /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/geno_files/inversion_filtered_autosomes.geno.gz -t 10 -p StHelena --popsFile /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/div_win/wild90_country.txt | gzip > /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/SH_SFS_P1.done 

python /ceph/users/smitchell/software/genomics_general/sfs.py -i /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz --inputType baseCounts --FSpops StHelena --pref SH_SFS_P2 && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/autosomes.SH_SFS_P2.done

#stairwayplot:
#example blueprint file
#input setting
popid: StHelena # id of the population (no white space)
nseq: 12 # number of sequences
L: 171973603 # total number of observed nucleic sites, including polymorphic and monomorphic
whether_folded: true # whethr the SFS is folded (true or false)
SFS: 	2602817	1612586	1256746	894319	540655	199712 # snp frequency spectrum: number of singleton, number of doubleton, etc. (separated by white space)
#smallest_size_of_SFS_bin_used_for_estimation: 1 # default is 1; to ignore singletons, uncomment this line and change this number to 2
#largest_size_of_SFS_bin_used_for_estimation: 15 # default is nseq/2 for folded SFS
pct_training: 0.67 # percentage of sites for training
nrand: 1 2 3 4 5 6 7 8 9 10 # number of random break points for each try (separated by white space)
project_dir: StHelena_fold # project directory
stairway_plot_dir: stairway_plot_es # directory to the stairway plot files
ninput: 200 # number of input files to be created for each estimation
#random_seed: 6
#output setting
mu: 2e-9 # assumed mutation rate per site per generation
year_per_generation: 0.11 # assumed generation time (in years)
#plot setting
plot_title: St Helena # title of the plot
xrange: 0.1,10000 # Time (1k year) range; format: xmin,xmax; "0,0" for default
yrange: 0,0 # Ne (1k individual) range; format: xmin,xmax; "0,0" for default
xspacing: 2 # X axis spacing
yspacing: 2 # Y axis spacing
fontsize: 12 # Font size



























































##HERE##

#filter one chromosome
#raw
bcftools view -H contig31.1.raw1.vcf.gz | wc -l
4430099

#realigned
bcftools view -H contig31.1.realigned.raw.vcf.gz | wc -l
4430099

##pre-indel realignment
bcftools filter -Oz ./contig31.1.raw1.vcf.gz -e 'FORMAT/DP < 8 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.filt.vcf.gz

##post-indel realignment
bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 8 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt.vcf.gz

bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt7.vcf.gz

bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 9 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt9.vcf.gz

bcftools view -H contig31.1.filt.vcf.gz | wc -l
4321554

bcftools view -H contig31.1.realigned.filt.vcf.gz | wc -l
4321531

##########
#Error test

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt.vcf.gz --skipIndels | bgzip > contig31.filt.geno.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt7.vcf.gz --skipIndels | bgzip > contig31.filt7.geno.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt9.vcf.gz --skipIndels | bgzip > contig31.filt9.geno.gz


python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.filt.vcf.gz --skipIndels | bgzip > contig31.filt.raw.geno.gz


python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts.output.csv

python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt7.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts7.output.csv

python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt9.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts9.output.csv


python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt.raw.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts.raw.output.csv

conda create -n PCA
sconda PCA
conda install -c bioconda plink

#test on one chromosome:
#contig31.1.realigned.filt7.vcf.gz

bcftools filter -Oz ./contig31.1.realigned.filt7.vcf.gz -e 'INFO/MAF > 0.05 | AN < 90' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./contig31.1.realigned.filt7.test.vcf.gz

bcftools view -H contig31.1.realigned.filt7.test.vcf.gz | wc -l

grep "SM17H" indiv.list > excl.list
grep "AB19" indiv.list >> excl.list
grep "RB20110" indiv.list >> excl.list
grep "SM20BE01" indiv.list >> excl.list

bcftools view -S ^excl.list -o contig31.1.realigned.filt7.test_droppedindivs.vcf.gz contig31.1.realigned.filt7.test.vcf.gz


plink --vcf contig31.1.realigned.filt7.test_droppedindivs.vcf.gz --double-id --allow-extra-chr \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out test_filt_noout

# prune and create pca
plink --vcf contig31.1.realigned.filt7.test_droppedindivs.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# \
--extract test_filt_noout.prune.in \
--make-bed --pca --out test_filt_noout

scp *.eigen* /data/martin/genomics/analyses/Danaus_popgen/Wild90/

bcftools filter -Oz ./Wild90_allchroms_output_filt_mindepth8_minqual30.vc.gz -e 'INFO/MAF > 0.05 | AN < 90' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth8_minqual30_maf0.05_missing90.vcf.gz

bcftools view -m2 -M2 -v snps Wild90_allchroms_output_filt_mindepth8_minqual30_maf0.05_missing90.vc.gz | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth8_minqual30_maf0.05_missing90_biallelic.vcf.gz

plink --vcf Wild90_allchroms_output_filt_mindepth8_minqual30_nomissing.vc.gz --double-id --allow-extra-chr \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out all90_filt_noout

# prune and create pca
plink --vcf Wild90_allchroms_output_filt_mindepth8_minqual30_nomissing.vc.gz --double-id --allow-extra-chr --set-missing-var-ids @:# \
--extract all90_filt_noout.prune.in \
--make-bed --pca --out all90_filt_noout




touch move_and_delete_scratch_bams.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "rsync /scratch/rdekayne/gatk/realigned.${bam} /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned.${bam} && rm /scratch/rdekayne/gatk/realigned.${bam}" >> move_and_delete_scratch_bams.txt



###Stairplot
#stairplot
qstat -f -u "*"

conda create -n angsd 
sconda angsd
conda install -c bioconda angsd=0.921
conda install -c conda-forge parallel

ls /data/martin/genomics/analyses/Danaus_mapping/SM16S*.Dchry2.2.*.bam > bam.list

cp /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa .
cp /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai .

cut -f1 Dchry2.2.fa.fai | grep -v "contig0." | grep -v "contig15.1" > /data/martin/genomics/analyses/Danaus_popgen/StHelena_project/angsd/chrom.list

cat chrom.list | while read line
do
	echo 'angsd -gl 2 -dosaf 1 -bam /scratch/rdekayne/angsd/bam.list -ref /scratch/rdekayne/angsd/Dchry2.2.fa -anc /scratch/rdekayne/angsd/Dchry2.2.fa -nThreads 1 -r '${line}' -baq 1 -C 50 -minMapQ 1 -P 30 -minQ 20 -out /scratch/rdekayne/angsd/output.'${line}'.baq1MQ1Q20GL2' >> angsd_run.txt
done

parallel -j 1 'qsub -cwd -N angsd -V -pe smp64 1 -l h=bigbang -b yes {}' :::: angsd_run.txt

#grep "Number of sites retained after filtering" *.e* | wc -l
#40

#grep "Number of sites retained after filtering" *.e* | cut -d':' -f3 > lengths.txt
#cat lengths.txt | awk '{SUM+=$1}END{print SUM}'
#310150036

#check output makes sense
realSFS print output.contig13.1.baq1MQ1Q20GL2.saf.idx | head

realSFS cat -outnames mergedALL *.idx

realSFS mergedALL.saf.idx -P 30 -maxIter 100 -bootstrap 20 > output.mergedALL.baq1MQ1Q20GL2.BS20.sfs

realSFS merged.saf.idx -P 60 -maxIter 100 -bootstrap 20 -fold 1 > output.merged.fodlded.baq1MQ1Q20GL2.BS20.sfs

#fold this manually with simon's R function

###OUTPUT
	-> Only read nSites: 0 will therefore prepare next chromosome (or exit)

	-> NB NB output is no longer log probs of the frequency spectrum!
	-> Output is now simply the expected values! 
	-> You can convert to the old format simply with log(norm(x))


###################

touch genotype_run.txt

cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list -r "${line}" | bcftools call -m -f GQ -O u | bcftools filter -e 'FORMAT/DP < 5 | FORMAT/GQ < 20' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bgzip > /scratch/rdekayne/genotyping/"${line}".vcf.gz" >> genotype_run.txt
done

#parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: genotype_run.txt

head -n2 genotype_run.txt > test.geno.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno.txt

head -n2 genotype_run.txt > test.geno.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno.txt


