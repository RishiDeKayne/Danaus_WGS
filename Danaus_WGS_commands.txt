#commands for ***

#check queue
qstat -f -u "*"

#1. Genotyping



########
#1. GENOTYPING
########

#make list of scaffolds
cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > /data/martin/genomics/analyses/Danaus_mapping/scaf.list

#prepare list of bams
#need to add full filepath
cp Wild100list_90inds_bam.list Wild100list_90inds_full_filepath_bam.list

sed -i 's/^/\/data\/martin\/genomics\/analyses\/Danaus_mapping\//g' Wild100list_90inds_full_filepath_bam.list
sed -i -e "s/\r//g" ./Wild100list_90inds_full_filepath_bam.list
sed -i -e "s/\r//g" ./Wild100list_90inds_bam.list

#############################################
#indel re-alignment:
#############################################

#make conda env for gatk
conda create -n gatk
sconda gatk
conda install -c conda-forge parallel
conda install -c conda-forge openjdk

# bam output dir. /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned

# executible is: /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar

#e.g. https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists

###FULL RUN
cd /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned

touch gatk_indel_realignment_creator_FULL_step1.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -o /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned_confirmed/intervals.${bam}.done" >> gatk_indel_realignment_creator_FULL_step1.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: gatk_indel_realignment_creator_FULL_step1.txt

#now move intervals to project folder
cp *.intervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals

#prepare next step - making new bams
touch gatk_indel_realignment_creator_FULL_step2.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -targetIntervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals/realigner.intervals.${bam}.intervals -o /scratch/rdekayne/gatk/realigned.${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned_confirmed/realigned.${bam}.done" >> gatk_indel_realignment_creator_FULL_step2.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: gatk_indel_realignment_creator_FULL_step2.txt

###assess bams with MOSDEPTH
#/data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth

ssh bigbang
mkdir /scratch/rdekayne/mosdepth_danaus/
cd /scratch/rdekayne/gatk

ls *.bam > /scratch/rdekayne/mosdepth_danaus/bam_nofilepath.list

touch mosdepth_run.txt
cat /scratch/rdekayne/mosdepth_danaus/bam_nofilepath.list | while read bam
do
echo "mosdepth -n ${bam} /scratch/rdekayne/gatk/${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/done_files/${bam}.done" >> mosdepth_run.txt
done

cp mosdepth_run.txt /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth

sconda genomics_general
parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigbang -b yes {}' :::: mosdepth_run.txt

mkdir plot_dist
cd plot_dist/

python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt

scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/plot_dist/dist.html .

grep "total" ../realigned.SM18W01.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam.mosdepth.summary.txt
#total   354020300       34859745395     98.47   0       22276

mkdir low_high_indivs
mv ../*SM18W01* low_high_indivs

#before genotyping want to downsample SM18W01 and move SM17H06 to rejected folder due to low coverage
ssh bigbang
cd /scratch/rdekayne/gatk/

sconda genomics_general
samtools view -s 0.30 -b realigned.SM18W01.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam > realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam

samtools index realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam

#now move old bam into rejected_indivs
mv realigned.SM18W01.UKDSW02200* rejected_individuals

#this leaves 90 individuals - 89 original and new subsampled SM18W01

#run mosdepth on this one sample - in /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth
echo "mosdepth -n realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam /scratch/rdekayne/gatk/realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam" > subsampled_mosdepth.txt

parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigbang -b yes {}' :::: subsampled_mosdepth.txt

#run mosdepth plot again for all 89 individuals
cd /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/plot_dist
python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt -o 90_inc_downsampled_dist.html
#and download

#now to genotyping (bigfoot)
ssh bigbang
mkdir -p /scratch/rdekayne/genotyping && cd /scratch/rdekayne/genotyping

#prepare list of bams
#need to add full filepath
ls /scratch/rdekayne/gatk/*.bam > bam.list

wc -l bam.list
#90

sconda genomics_general

touch geno_realigned_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/genotyping/bam.list -r "${line}" | bcftools call -m -f GQ -O v | bgzip > /scratch/rdekayne/genotyping/"${line}".realigned.raw.vcf.gz && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/genotyping/done_files/"${line}".realigned.raw.vcf.gz.done" >> geno_realigned_1pop.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: geno_realigned_1pop.txt

#now move zipped vcfs back to 
mkdir /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs
scp *.gz /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/

#now make a file listing these vcfs 
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/
ls *.gz > vcf.list

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs

#now filter chromosome vcfs
touch make.filt.chroms.txt
cat /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/vcf.list | while read line
do
echo "bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/Wild90/raw_chr_vcfs/"${line}" -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/"${line}"_filt_mindepth7_minqual30.vcf.gz" >> make.filt.chroms.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: make.filt.chroms.txt

then make a list
ls *.vcf.gz > filt_vcf.list

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos
#now convert these to .geno format
touch make.chr.genos.txt
cat /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/filt_vcf.list | while read line
do
echo "python /data/martin/genomics/analyses/Danaus_popgen/Wild90/genomics_general/VCF_processing/parseVCF.py -i /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/"${line}" --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos/"${line}".minQual30.mindp7.maxdp50.geno.gz && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_genos/"${line}".done" >> make.chr.genos.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: make.chr.genos.txt

#merge into a single file:
ls /data/martin/genomics/analyses/Danaus_popgen/Wild90/filt_chr_vcfs/*.gz > vcf_to_merge.txt

bcftools concat -Ou -f vcf_to_merge.txt | bcftools sort -Oz -o /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz

ssh bigshot
mkdir -p /scratch/rdekayne/PCAs && cd /scratch/rdekayne/PCAs

bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAC < 4 | AN < 180' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN180.vcf.gz

bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAC < 4 | AN < 90' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.vcf.gz

bcftools filter -Oz /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAC < 4 | AN < 162' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.vcf.gz

bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz | wc -l
#349214931
bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN180.vcf.gz | wc -l
#2150522
bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.vcf.gz | wc -l
#18817583
bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.vcf.gz | wc -l
#11511103

mv *.vcf.gz /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs

#make excl_list.txt listing individuals to get rid of:
SM17H01
SM17H02
SM17H03
SM17H04
SM17H05
SM17H07
AB19401

bcftools view -S ^excl_list.txt -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN180_dropped_indivs.vcf /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN180.vcf.gz

bcftools view -S ^excl_list.txt -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90_dropped_indivs.vcf /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.vcf.gz

bcftools view -S ^excl_list.txt -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs.vcf /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.vcf.gz


gzip Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN180_dropped_indivs.vcf 
gzip Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90_dropped_indivs.vcf 
gzip Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs.vcf 

mv *.vcf.gz /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs

#assess missing data %s across individuals
vcftools --gzvcf /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.vcf.gz --missing-indv --out missing_AN90

vcftools --gzvcf /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.vcf.gz --missing-indv --out missing_AN162

vcftools --gzvcf /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN180.vcf.gz --missing-indv --out missing_AN180

cp *missing_*.imiss /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/summary_stats

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/summary_stats/* /Users/rishide-kayne/Dropbox/RishiMac2/Danaus/Wild90/summary_stats


######################
######################
#	PCAS
######################
######################

#using our AN162 set for PCAs in total = 
#all run with st helena + AB19401 and then without
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA

zcat /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.vcf.gz | bgzip -c > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.b.vcf.gz && tabix Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.b.vcf.gz

zcat /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs.vcf.gz | bgzip -c > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs.b.vcf.gz && tabix Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs.b.vcf.gz

ssh bigshot
cd /scratch/rdekayne/PCAs

#remove small contigs
grep "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > small_scafs.txt

awk '{print $1, $2}' small_scafs.txt | sed 's/ /\t0\t/g' > small_scafs_remove.txt

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162.b.vcf.gz -T ^small_scafs_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs.b.vcf.gz -T ^small_scafs_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs.b.vcf.gz


#############
#1. full genome excluding chr 15

grep "contig15.1" /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > chr15_info.txt

awk '{print $1, $2}' chr15_info.txt | sed 's/ /\t0\t/g' > chr15_info_remove.txt

#filter out chr15
bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_nochr15.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz

#make filtered PCAs
sconda PCA
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 1_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 1_all_filt_noout.prune.in --make-bed --pca --out 1_all_filt_noout
#3708139 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 1_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 1_dropped_filt_noout.prune.in --make-bed --pca --out 1_dropped_filt_noout
#3726061 variants and 83 people pass filters and QC.


#make unfiltered PCAs
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 1_all_noout
#10961897 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 1_dropped_noout
#10961897 variants and 83 people pass filters and QC.

#############
#2. all chr15

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz

#make filtered PCAs
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 2_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 2_chr15_all_filt_noout.prune.in --make-bed --pca --out 2_chr15_all_filt_noout
#96909 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 2_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 2_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 2_chr15_dropped_filt_noout
#149224 variants and 83 people pass filters and QC.
#97415 variants and 83 people pass filters and QC.

#make unfiltered PCAs
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 2_chr15_all_noout
#487392 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 2_chr15_dropped_noout
#487392 variants and 83 people pass filters and QC.

#for the next set use: Dchry2.2_region_coordinates.tsv
#############
#3. chr15 no SVs 

cp /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/Dchry2.2_region_coordinates.tsv .
sed -i 's/chr15/contig15.1/g' Dchry2.2_region_coordinates.tsv

#now want to just keep columns 1,5,6,8

awk '{print $1,$5,$6,$8}' Dchry2.2_region_coordinates.tsv | tail -n +2 > Dchry2.2_region_coordinates_simple.bed

awk '{print $1}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > chr.txt
awk '{print $2}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > start.txt
awk '{print $3}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > end.txt

paste -d '\t' chr.txt start.txt > chr_start.txt
paste -d '\t' chr_start.txt end.txt > targets.txt 

wc -l targets.txt
#28 targets.txt

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T ^targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_nosvs.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T ^targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz

#make filtered PCAs
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 3_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 3_chr15_all_filt_noout.prune.in --make-bed --pca --out 3_chr15_all_filt_noout
#131727 variants and 90 people pass filters and QC.
#89037 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 3_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 3_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 3_chr15_dropped_filt_noout
#89645 variants and 83 people pass filters and QC.

#make unfiltered PCAs
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 3_chr15_all_noout
#386709 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 3_chr15_dropped_noout


#############
#4. chr15 region 1 - contig15.1	4035981	6220875

echo "contig15.1 4035981 6220875" > region1.txt
sed -i 's/ /\t/g' region1.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T region1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 4_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 4_chr15_all_filt_noout.prune.in --make-bed --pca --out 4_chr15_all_filt_noout
#7935 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 4_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 4_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 4_chr15_dropped_filt_noout
#8145 variants and 83 people pass filters and QC.

#unfiltered pca
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 4_chr15_all_noout
#71482 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 4_chr15_dropped_noout


#############
#5. chr15 region 2 - contig15.1 6251636-7829094

echo "contig15.1 6251636 7829094" > region2.txt
sed -i 's/ /\t/g' region2.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T region2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 5_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 5_chr15_all_filt_noout.prune.in --make-bed --pca --out 5_chr15_all_filt_noout
#3428 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 5_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 5_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 5_chr15_dropped_filt_noout
#3336 variants and 83 people pass filters and QC.

#unfiltered pca
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 5_chr15_all_noout
#47470 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 5_chr15_dropped_noout


#############
#6. chr15 region 4 - contig15.1 14803486-15299732

echo "contig15.1 14803486 15299732" > region4.txt
sed -i 's/ /\t/g' region4.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T region4.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region4.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 6_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 6_chr15_all_filt_noout.prune.in --make-bed --pca --out 6_chr15_all_filt_noout
#1746 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 6_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 6_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 6_chr15_dropped_filt_noout
#1736 variants and 83 people pass filters and QC.

#unfilt pcas
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 6_chr15_all_noout
#22913 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 6_chr15_dropped_noout


#############
#7. chr15 region 3

awk -F' ' '{if ($4=="3") print $0}' Dchry2.2_region_coordinates_simple.bed > region3.bed

awk '{print $1}' region3.bed | tail -n +2 > region3_chr.txt
awk '{print $2}' region3.bed | tail -n +2 > region3_start.txt
awk '{print $3}' region3.bed | tail -n +2 > region3_end.txt

paste -d '\t' region3_chr.txt region3_start.txt > region3_chr_start.txt
paste -d '\t' region3_chr_start.txt region3_end.txt > region3_targets.txt 


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T region3_targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region3.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region3_targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 7_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 7_chr15_all_filt_noout.prune.in --make-bed --pca --out 7_chr15_all_filt_noout
#2681 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 7_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 7_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 7_chr15_dropped_filt_noout
#2701 variants and 83 people pass filters and QC.

#unfiltered pcas
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 7_chr15_all_noout
#30004 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 7_chr15_dropped_noout


#############
#8. chr15 region 1.1 - contig15.1	4035981	5322257

echo "contig15.1 4035981 5322257" > region1.1.txt
sed -i 's/ /\t/g' region1.1.txt


bcftools view Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T region1.1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1.b.vcf.gz

bcftools view Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 8_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 8_chr15_all_filt_noout.prune.in --make-bed --pca --out 8_chr15_all_filt_noout
#6224 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 8_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 8_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 8_chr15_dropped_filt_noout
#6420 variants and 83 people pass filters and QC.

#unfiltered pcas
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 8_chr15_all_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 8_chr15_dropped_noout
#44062 variants and 83 people pass filters and QC.

#############
#9. chr15 region 1.2 - contig15.1	5323805	6220875

echo "contig15.1 5323805 6220875" > region1.2.txt
sed -i 's/ /\t/g' region1.2.txt


bcftools view Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T region1.2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2.b.vcf.gz

bcftools view Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 9_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 9_chr15_all_filt_noout.prune.in --make-bed --pca --out 9_chr15_all_filt_noout
#1707 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 9_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 9_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 9_chr15_dropped_filt_noout
#1722 variants and 83 people pass filters and QC.

#unfiltered pcas
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 9_chr15_all_noout
#27417 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --make-bed --pca --out 9_chr15_dropped_noout

#now move everything
mv * /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA 
mv *.vcf.gz ../../merged_vcfs/
mv *.tbi ../../merged_vcfs/

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/*.eigen* /Users/rishide-kayne/Dropbox/RishiMac2/Danaus/Wild90/PCAs/

######################
######################
#	ADMIXTURE
######################
######################

#admixture
conda create -n admixture
sconda admixture
conda install -c bioconda admixture

ssh bigshot
mkdir -p /scratch/rdekayne/PCAs && cd /scratch/rdekayne/PCAs

sconda PCA

grep -v "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai | cut -f1 > all_scafs_info.txt

awk '{print $0 "\t" NR }' all_scafs_info.txt | sed 's/\t/\tchr/g' > rename_file.txt

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_nochr15.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_nochr15_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_nochr15_renamed.b.vcf.gz
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 41 \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out admix_in

#Pruning complete.  7253758 of 10961897 variants removed.


# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 41 --set-missing-var-ids @:# \
--extract admix_in.prune.in \
--make-bed --pca --out admix_in

#3708139 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture
touch admixture_run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}_admix_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/log${K}_admix_in.out.done" >> admixture_run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_run.txt

#get error
grep "CV error" *.o*

admixture.o112739:CV error (K=2): 0.34371
admixture.o112740:CV error (K=3): 0.37561
admixture.o112741:CV error (K=4): 0.40693
admixture.o112742:CV error (K=5): 0.43730
admixture.o112743:CV error (K=6): 0.46678
admixture.o112744:CV error (K=7): 0.49150
admixture.o112745:CV error (K=8): 0.51295
admixture.o112746:CV error (K=9): 0.54762
admixture.o112747:CV error (K=10): 0.57907
admixture.o112748:CV error (K=11): 0.61485
admixture.o112749:CV error (K=12): 0.65982

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/*.Q .


#################
##now for chr15
bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_in

#487392 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15
touch admixture_chr15.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}_admix_chr15_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15/log${K}_admix_chr15_in.out.done" >> admixture_chr15.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15.run.txt

grep "CV error" *.o*

admixture.o112774:CV error (K=2): 0.31080
admixture.o112775:CV error (K=3): 0.30768
admixture.o112776:CV error (K=4): 0.29351
admixture.o112777:CV error (K=5): 0.29437
admixture.o112778:CV error (K=6): 0.29945
admixture.o112779:CV error (K=7): 0.30119
admixture.o112780:CV error (K=8): 0.32494
admixture.o112781:CV error (K=9): 0.33887
admixture.o112782:CV error (K=10): 0.36928
admixture.o112783:CV error (K=11): 0.38326
admixture.o112784:CV error (K=12): 0.38820

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/*.Q .

ssh bigshot
cd /scratch/rdekayne/PCAs/
mv * /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/


###########
#now just sv regions
touch SV_regions.txt
echo "contig15.1 4035981 5322257" >> SV_regions.txt
echo "contig15.1 5323805 6220875" >> SV_regions.txt
echo "contig15.1 6251636 7829094" >> SV_regions.txt
echo "contig15.1 14803486 15299732" >> SV_regions.txt
sed -i 's/ /\t/g' SV_regions.txt

bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15.b.vcf.gz -T SV_regions.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions.b.vcf.gz

bcftools annotate --rename-chrs rename_file.txt Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_SV_regions_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_SVs_in

#141862 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15_SVs
touch admixture_chr15_SVs.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_SVs_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_SVs_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/chr15_SVs/log${K}admix_chr15_SVs_in.out.done" >> admixture_chr15_SVs.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_SVs.run.txt

grep "CV error" *.o*

###########
#now just region1.1

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.1_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_1.1_in

#44062 variants and 90 samples pass filters and QC.

/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_1
touch admixture_chr15_1_1.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_1.1_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_1.1_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_1/log${K}admix_chr15_1.1_in.out.done" >> admixture_chr15_1_1.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_1_1.run.txt

grep "CV error" *.o*
admixture.o112822:CV error (K=2): 0.27112
admixture.o112823:CV error (K=3): 0.26009
admixture.o112824:CV error (K=4): 0.24243
admixture.o112825:CV error (K=5): 0.23631
admixture.o112826:CV error (K=6): 0.23711
admixture.o112827:CV error (K=7): 0.23773
admixture.o112828:CV error (K=8): 0.25986
admixture.o112829:CV error (K=9): 0.26922
admixture.o112830:CV error (K=10): 0.28153
admixture.o112831:CV error (K=11): 0.29048
admixture.o112832:CV error (K=12): 0.32202

###########
#now just region1.2

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region1.2_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_1.2_in

#27417 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_2
touch admixture_chr15_1_2.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_1.2_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_1.2_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region1_2/log${K}admix_chr15_1.2_in.out.done" >> admixture_chr15_1_2.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_1_2.run.txt

grep "CV error" *.o*
admixture.o112833:CV error (K=2): 0.27599
admixture.o112834:CV error (K=3): 0.18538
admixture.o112835:CV error (K=4): 0.15799
admixture.o112836:CV error (K=5): 0.12770
admixture.o112837:CV error (K=6): 0.11967
admixture.o112838:CV error (K=7): 0.11794
admixture.o112839:CV error (K=8): 0.12679
admixture.o112840:CV error (K=9): 0.12508
admixture.o112841:CV error (K=10): 0.13903
admixture.o112842:CV error (K=11): 0.14252
admixture.o112843:CV error (K=12): 0.14602

###########
#now just region2

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region2_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_2_in

#47470 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region2
touch admixture_chr15_2.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_2_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_2_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region2/log${K}admix_chr15_2_in.out.done" >> admixture_chr15_2.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_2.run.txt

grep "CV error" *.o*
admixture.o112844:CV error (K=2): 0.30578
admixture.o112845:CV error (K=3): 0.21263
admixture.o112846:CV error (K=4): 0.17768
admixture.o112847:CV error (K=5): 0.16711
admixture.o112848:CV error (K=6): 0.14204
admixture.o112849:CV error (K=7): 0.14709
admixture.o112850:CV error (K=8): 0.14127
admixture.o112851:CV error (K=9): 0.15247
admixture.o112852:CV error (K=10): 0.15464
admixture.o112853:CV error (K=11): 0.15580
admixture.o112854:CV error (K=12): 0.16153

###########
#now just region4

bcftools annotate --rename-chrs rename_file.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4.b.vcf.gz | bgzip > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4_renamed.b.vcf.gz

VCF_FILE=Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN162_nosmallcontigs_CHR15_region4_renamed.b.vcf.gz

# prune and create pca
plink --vcf $VCF_FILE --double-id --allow-extra-chr --autosome-num 17 --set-missing-var-ids @:# \
--make-bed --pca --out admix_chr15_4_in

#22913 variants and 90 samples pass filters and QC.

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region4
touch admixture_chr15_4.run.txt
for K in {2..12}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/PCAs/admix_chr15_4_in.bed ${K} | tee /scratch/rdekayne/PCAs/log${K}admix_chr15_4_in.out && touch /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/admixture/region4/log${K}admix_chr15_4_in.out.done" >> admixture_chr15_4.run.txt
done

parallel -j 1 'qsub -cwd -N admixture -V -pe smp64 1 -l h=bigshot -b yes {}' :::: admixture_chr15_4.run.txt

grep "CV error" *.o*
admixture.o112855:CV error (K=2): 0.32323
admixture.o112856:CV error (K=3): 0.29803
admixture.o112857:CV error (K=4): 0.28747
admixture.o112858:CV error (K=5): 0.26698
admixture.o112859:CV error (K=6): 0.26972
admixture.o112860:CV error (K=7): 0.27037
admixture.o112861:CV error (K=8): 0.26194
admixture.o112862:CV error (K=9): 0.27706
admixture.o112863:CV error (K=10): 0.28213
admixture.o112864:CV error (K=11): 0.29393
admixture.o112865:CV error (K=12): 0.30239

######################
######################
#	GEMMA - GWAS
######################
######################

#install GEMMA

#1. hindwing colour

#2. forewing patch

#3. white hindwing



######################
######################
#	WHATSHAP
######################
######################

#whatshap for phasing of wild90 dataset

ssh bigshot
mkdir -p /scratch/rdekayne/whatshap && cd /scratch/rdekayne/whatshap

#first we want to have haploid genotypes for the known alleles we have previously assembled


########MB18102#########
#first align whole assembly of MB18102MAT to the reference (-a option exports SAM format)
cp /data/martin/genomics/analyses/Danaus_genome/MB181_trio/KKIM_assemblies/v8/polished/MB18102_MAT.fasta.gz .
cp /data/martin/genomics/analyses/Danaus_genome/MB181_trio/KKIM_assemblies/v8/polished/MB18102_PAT.fasta.gz .

gunzip *.gz

sconda /ceph/users/smartin/.conda/envs/minimap2/

minimap2 -ax asm10 -R '@RG\\tID:MB18102MAT\\tSM:MB18102MAT' /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa ./MB18102_MAT.fasta | samtools view -Sb > Dchry2.2_MB18102MAT_minimap2.asm10.bam

minimap2 -ax asm10 -R '@RG\\tID:MB18102PAT\\tSM:MB18102PAT' /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa ./MB18102_PAT.fasta | samtools view -Sb > Dchry2.2_MB18102PAT_minimap2.asm10.bam

mv *.bam /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap

ssh bigfoot
cd /scratch/rdekayne/whatshap_wild90
sconda genomics_general

#sort bam
samtools sort /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap/Dchry2.2_MB18102MAT_minimap2.asm10.bam > ./Dchry2.2_MB18102MAT_minimap2.asm10.sort.bam
samtools sort /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap/Dchry2.2_MB18102PAT_minimap2.asm10.bam > ./Dchry2.2_MB18102PAT_minimap2.asm10.sort.bam

mv *.bam /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap

rm /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap/Dchry2.2_MB18102MAT_minimap2.asm10.bam
rm /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap/Dchry2.2_MB18102PAT_minimap2.asm10.bam

#genotype (could use -r to specify just the region of interest, DP == 1 because we only want single copy alignments)

bcftools mpileup --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --min-MQ 60 --annotate FORMAT/DP /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap/Dchry2.2_MB18102MAT_minimap2.asm10.sort.bam | bcftools call -m -f GQ --ploidy 1 | bcftools filter -i 'FORMAT/DP == 1' -O z > MB18102MAT_minimap2.asm10.vcf.gz

bcftools mpileup --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --min-MQ 60 --annotate FORMAT/DP /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/whatshap/Dchry2.2_MB18102PAT_minimap2.asm10.sort.bam | bcftools call -m -f GQ --ploidy 1 | bcftools filter -i 'FORMAT/DP == 1' -O z > MB18102PAT_minimap2.asm10.vcf.gz

#now filter these loci in the same way as our main vcf:

#now merge vcfs:
#first need to bgzip and tabix all vcfs
zcat MB18102MAT_minimap2.asm10.vcf.gz | bgzip -c > MB18102MAT_minimap2.asm10.b.vcf.gz && tabix MB18102MAT_minimap2.asm10.b.vcf.gz

zcat MB18102PAT_minimap2.asm10.vcf.gz | bgzip -c > MB18102PAT_minimap2.asm10.b.vcf.gz && tabix MB18102PAT_minimap2.asm10.b.vcf.gz


########SB211#########
#now for the SB211 assemblies
cp /data/martin/genomics/analyses/Danaus_genome/SB211_trio/assemblies/SB211_MAT.fasta.gz .
cp /data/martin/genomics/analyses/Danaus_genome/SB211_trio/assemblies/SB211_PAT.fasta.gz .

gunzip SB211*.gz

sconda /ceph/users/smartin/.conda/envs/minimap2/

minimap2 -ax asm10 -R '@RG\\tID:SB211MAT\\tSM:SB211MAT' /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa ./SB211_MAT.fasta | samtools view -Sb > Dchry2.2_SB211MAT_minimap2.asm10.bam

minimap2 -ax asm10 -R '@RG\\tID:SB211PAT\\tSM:SB211PAT' /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa ./SB211_PAT.fasta | samtools view -Sb > Dchry2.2_SB211PAT_minimap2.asm10.bam

#sort bam
samtools sort Dchry2.2_SB211MAT_minimap2.asm10.bam > Dchry2.2_SB211MAT_minimap2.asm10.sort.bam
samtools sort Dchry2.2_SB211PAT_minimap2.asm10.bam > Dchry2.2_SB211PAT_minimap2.asm10.sort.bam

rm Dchry2.2_SB211MAT_minimap2.asm10.bam
rm Dchry2.2_SB211PAT_minimap2.asm10.bam

#genotype (could use -r to specify just the region of interest, DP == 1 because we only want single copy alignments)

bcftools mpileup --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --min-MQ 60 --annotate FORMAT/DP Dchry2.2_SB211MAT_minimap2.asm10.sort.bam | bcftools call -m -f GQ --ploidy 1 | bcftools filter -i 'FORMAT/DP == 1' -O z > SB211MAT_minimap2.asm10.vcf.gz

bcftools mpileup --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --min-MQ 60 --annotate FORMAT/DP Dchry2.2_SB211PAT_minimap2.asm10.sort.bam | bcftools call -m -f GQ --ploidy 1 | bcftools filter -i 'FORMAT/DP == 1' -O z > SB211PAT_minimap2.asm10.vcf.gz

#now filter these loci to only include sites in our main vcf:

zcat SB211MAT_minimap2.asm10.vcf.gz | bgzip -c > SB211MAT_minimap2.asm10.b.vcf.gz && tabix SB211MAT_minimap2.asm10.b.vcf.gz

zcat SB211PAT_minimap2.asm10.vcf.gz | bgzip -c > SB211PAT_minimap2.asm10.b.vcf.gz && tabix SB211PAT_minimap2.asm10.b.vcf.gz


#now get list of sites in our main vcf:

cp /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.vcf.gz .

zcat Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.vcf.gz | bgzip -c > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.b.vcf.gz && tabix Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.b.vcf.gz

bcftools query -f '%CHROM %POS\n' Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.b.vcf.gz > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites.txt

awk '{print $1,$2,$2}' Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites.txt  > Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites_formatted.txt

sed -i 's/ /\t/g' Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites_formatted.txt

bcftools view -H MB18102MAT_minimap2.asm10.b.vcf.gz | wc -l
#185073482

bcftools view -H MB18102PAT_minimap2.asm10.b.vcf.gz | wc -l
#214253076

bcftools view -H SB211MAT_minimap2.asm10.b.vcf.gz | wc -l
#188801246

bcftools view -H SB211PAT_minimap2.asm10.b.vcf.gz | wc -l
#202842085

#now filter for only the positions shared with our main vcf:
bcftools view ./MB18102MAT_minimap2.asm10.b.vcf.gz -T ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites_formatted.txt -Oz > ./MB18102MAT_minimap2.asm10_shared_sites.b.vcf.gz

bcftools view ./MB18102PAT_minimap2.asm10.b.vcf.gz -T ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites_formatted.txt -Oz > ./MB18102PAT_minimap2.asm10_shared_sites.b.vcf.gz

bcftools view ./SB211MAT_minimap2.asm10.b.vcf.gz -T ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites_formatted.txt -Oz > ./SB211MAT_minimap2.asm10_shared_sites.b.vcf.gz

bcftools view ./SB211PAT_minimap2.asm10.b.vcf.gz -T ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.sites_formatted.txt -Oz > ./SB211PAT_minimap2.asm10_shared_sites.b.vcf.gz

#now check after
bcftools view -H MB18102MAT_minimap2.asm10_shared_sites.b.vcf.gz | wc -l
#13212003

bcftools view -H MB18102PAT_minimap2.asm10_shared_sites.b.vcf.gz | wc -l
#14322440

bcftools view -H SB211MAT_minimap2.asm10_shared_sites.b.vcf.gz | wc -l
#13298040

bcftools view -H SB211PAT_minimap2.asm10_shared_sites.b.vcf.gz | wc -l
#13829875

#generate indices
tabix MB18102MAT_minimap2.asm10_shared_sites.b.vcf.gz
tabix MB18102PAT_minimap2.asm10_shared_sites.b.vcf.gz
tabix SB211MAT_minimap2.asm10_shared_sites.b.vcf.gz
tabix SB211PAT_minimap2.asm10_shared_sites.b.vcf.gz

#and now merge everything
bcftools merge Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.b.vcf.gz MB18102MAT_minimap2.asm10_shared_sites.b.vcf.gz MB18102PAT_minimap2.asm10_shared_sites.b.vcf.gz SB211MAT_minimap2.asm10_shared_sites.b.vcf.gz SB211PAT_minimap2.asm10_shared_sites.b.vcf.gz | bgzip -c  > merged.92.b.vcf.gz && tabix merged.92.b.vcf.gz

bcftools query -l merged.92.b.vcf.gz

#fix weird naming: rename_indivs.txt
\/data\/martin\/genomics\/analyses\/Danaus_popgen\/Wild90\/analysis\/whatshap\/Dchry2.2_MB18102MAT_minimap2.asm10.sort.bam MB18102MAT
\/data\/martin\/genomics\/analyses\/Danaus_popgen\/Wild90\/analysis\/whatshap\/Dchry2.2_MB18102PAT_minimap2.asm10.sort.bam MB18102PAT
Dchry2.2_SB211MAT_minimap2.asm10.sort.bam SB211MAT
Dchry2.2_SB211PAT_minimap2.asm10.sort.bam SB211PAT

bcftools reheader -s rename_indivs.txt -o merged.92_renamed.b.vcf merged.92.b.vcf.gz
bcftools sort -Oz -o merged.92_renamed_sorted.b.vcf merged.92_renamed.b.vcf
mv merged.92_renamed_sorted.b.vcf merged.92_renamed_sorted.b.vcf.gz
tabix merged.92_renamed_sorted.b.vcf.gz

#now filter file to max 10% missing data

#use vcf lib to adjust the AN count
vcffixup merged.92_renamed_sorted.b.vcf.gz > merged.92_renamed_sorted_fixed.b.vcf.gz


bcftools filter -Oz merged.92_renamed_sorted_fixed.b.vcf.gz -e 'AN < 162' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./merged.92_renamed_sorted_fixed_AN162.b.vcf.gz



#now for phasing
samtools view -b /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/bams/realigned.SM17H01.302.200115.Dchry2.2.bwa.default.rmdup.bam_twosets.bam contig15.1 > test.bam






######################
######################
#	SPLITSTREE
######################
######################

##splitstree
bcftools +prune -l 0.2 -w 10000 /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz -Oz -o Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.vcf.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i /scratch/rdekayne/genotyping/popgen/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=5 max=50 -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.geno.gz

python /ceph/users/smartin/Research/genomics_general/distMat.py -g Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.geno.gz -f phased --windType cat -o Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.dist


######################
######################
#	RAXML
######################
######################


######################
######################
#	STAIRWAYPLOT
######################
######################
#want to have stairwayplot estimates for each population/morph type

python /ceph/users/smitchell/software/genomics_general/freq.py -g /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/geno_files/inversion_filtered_autosomes.geno.gz -t 10 -p StHelena --popsFile /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/div_win/wild90_country.txt | gzip > /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/SH_SFS_P1.done 

python /ceph/users/smitchell/software/genomics_general/sfs.py -i /scratch/smitchell/autosomes.SH_SFS_P1.tsv.gz --inputType baseCounts --FSpops StHelena --pref SH_SFS_P2 && touch /data/martin/genomics/analyses/Danaus_popgen/StHelena_project_Sam/SP2/SFS/SH/autosomes.SH_SFS_P2.done

#stairwayplot:
#example blueprint file
#input setting
popid: StHelena # id of the population (no white space)
nseq: 12 # number of sequences
L: 171973603 # total number of observed nucleic sites, including polymorphic and monomorphic
whether_folded: true # whethr the SFS is folded (true or false)
SFS: 	2602817	1612586	1256746	894319	540655	199712 # snp frequency spectrum: number of singleton, number of doubleton, etc. (separated by white space)
#smallest_size_of_SFS_bin_used_for_estimation: 1 # default is 1; to ignore singletons, uncomment this line and change this number to 2
#largest_size_of_SFS_bin_used_for_estimation: 15 # default is nseq/2 for folded SFS
pct_training: 0.67 # percentage of sites for training
nrand: 1 2 3 4 5 6 7 8 9 10 # number of random break points for each try (separated by white space)
project_dir: StHelena_fold # project directory
stairway_plot_dir: stairway_plot_es # directory to the stairway plot files
ninput: 200 # number of input files to be created for each estimation
#random_seed: 6
#output setting
mu: 2e-9 # assumed mutation rate per site per generation
year_per_generation: 0.11 # assumed generation time (in years)
#plot setting
plot_title: St Helena # title of the plot
xrange: 0.1,10000 # Time (1k year) range; format: xmin,xmax; "0,0" for default
yrange: 0,0 # Ne (1k individual) range; format: xmin,xmax; "0,0" for default
xspacing: 2 # X axis spacing
yspacing: 2 # Y axis spacing
fontsize: 12 # Font size



























































##HERE##

#filter one chromosome
#raw
bcftools view -H contig31.1.raw1.vcf.gz | wc -l
4430099

#realigned
bcftools view -H contig31.1.realigned.raw.vcf.gz | wc -l
4430099

##pre-indel realignment
bcftools filter -Oz ./contig31.1.raw1.vcf.gz -e 'FORMAT/DP < 8 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.filt.vcf.gz

##post-indel realignment
bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 8 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt.vcf.gz

bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt7.vcf.gz

bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 9 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt9.vcf.gz

bcftools view -H contig31.1.filt.vcf.gz | wc -l
4321554

bcftools view -H contig31.1.realigned.filt.vcf.gz | wc -l
4321531

##########
#Error test

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt.vcf.gz --skipIndels | bgzip > contig31.filt.geno.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt7.vcf.gz --skipIndels | bgzip > contig31.filt7.geno.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt9.vcf.gz --skipIndels | bgzip > contig31.filt9.geno.gz


python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.filt.vcf.gz --skipIndels | bgzip > contig31.filt.raw.geno.gz


python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts.output.csv

python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt7.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts7.output.csv

python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt9.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts9.output.csv


python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt.raw.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts.raw.output.csv

conda create -n PCA
sconda PCA
conda install -c bioconda plink

#test on one chromosome:
#contig31.1.realigned.filt7.vcf.gz

bcftools filter -Oz ./contig31.1.realigned.filt7.vcf.gz -e 'INFO/MAF > 0.05 | AN < 90' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./contig31.1.realigned.filt7.test.vcf.gz

bcftools view -H contig31.1.realigned.filt7.test.vcf.gz | wc -l

grep "SM17H" indiv.list > excl.list
grep "AB19" indiv.list >> excl.list
grep "RB20110" indiv.list >> excl.list
grep "SM20BE01" indiv.list >> excl.list

bcftools view -S ^excl.list -o contig31.1.realigned.filt7.test_droppedindivs.vcf.gz contig31.1.realigned.filt7.test.vcf.gz










###################




#############################
##############################
#	RARE VARIANTS
##############################
#############################

bcftools filter -Oz ./Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAF > 3 | AN < 180' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_mac4_AN90.vcf.gz


bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz | wc -l
#349214931
bcftools view -H Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz | wc -l
#12963087

#make excl_list.txt listing individuals to get rid of:
SM17H01
SM17H02
SM17H03
SM17H04
SM17H05
SM17H07
AB19401

bcftools view -S ^excl_list.txt -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf

gzip Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf

######################
######################
#	PCAS
######################
######################

#using no missing data for PCAs in total = 
#all run with st helena + AB19401 and then without
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA

zcat Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz | bgzip -c > Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz && tabix Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz

zcat Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz | bgzip -c > Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz && tabix Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz

ssh bigbang
cd /scratch/rdekayne/genotyping/combined_vcf

cp /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz .
cp /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz .

#remove small contigs
grep "contig0." /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > small_scafs.txt

awk '{print $1, $2}' small_scafs.txt | sed 's/ /\t0\t/g' > small_scafs_remove.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.b.vcf.gz -T ^small_scafs_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.b.vcf.gz -T ^small_scafs_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs.b.vcf.gz

#############
#1. full genome excluding chr 15

grep "contig15.1" /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > chr15_info.txt

awk '{print $1, $2}' chr15_info.txt | sed 's/ /\t0\t/g' > chr15_info_remove.txt

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs.b.vcf.gz -T ^chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz


sconda PCA
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 1_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 1_all_filt_noout.prune.in --make-bed --pca --out 1_all_filt_noout
#4735421 variants and 90 people pass filters and QC.


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 1_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_nochr15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 1_dropped_filt_noout.prune.in --make-bed --pca --out 1_dropped_filt_noout
#4639957 variants and 83 people pass filters and QC.


cp *_filt_noout.eigenval 90_filt_noout.eigenvec /data/martin/genomics/analyses/Danaus_popgen/Wild90/analyses/PCAs

#############
#2. all chr15

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs.b.vcf.gz -T chr15_info_remove.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 2_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 2_chr15_all_filt_noout.prune.in --make-bed --pca --out 2_chr15_all_filt_noout
#152527 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 2_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 2_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 2_chr15_dropped_filt_noout
#149224 variants and 83 people pass filters and QC.

#for the next set use: Dchry2.2_region_coordinates.tsv
#############
#3. chr15 no SVs 

sed -i 's/chr15/contig15.1/g' Dchry2.2_region_coordinates.tsv

#now want to just keep columns 1,5,6,8

awk '{print $1,$5,$6,$8}' Dchry2.2_region_coordinates.tsv | tail -n +2 > Dchry2.2_region_coordinates_simple.bed

awk '{print $1}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > chr.txt
awk '{print $2}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > start.txt
awk '{print $3}' Dchry2.2_region_coordinates_simple.bed | tail -n +2 > end.txt

paste -d '\t' chr.txt start.txt > chr_start.txt
paste -d '\t' chr_start.txt end.txt > targets.txt 

wc -l targets.txt
#28 targets.txt

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T ^targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_nosvs.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T ^targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 3_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 3_chr15_all_filt_noout.prune.in --make-bed --pca --out 3_chr15_all_filt_noout
#131727 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 3_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_nosvs.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 3_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 3_chr15_dropped_filt_noout
#128865 variants and 83 people pass filters and QC.

#############
#4. chr15 region 1 - contig15.1	4035981	6220875

echo "contig15.1 4035981 6220875" > region1.txt
sed -i 's/ /\t/g' region1.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 4_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 4_chr15_all_filt_noout.prune.in --make-bed --pca --out 4_chr15_all_filt_noout
#22206 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 4_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 4_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 4_chr15_dropped_filt_noout
#21633 variants and 83 people pass filters and QC.

#############
#5. chr15 region 2 - contig15.1 6251636-7829094

echo "contig15.1 6251636 7829094" > region2.txt
sed -i 's/ /\t/g' region2.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region2.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 5_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 5_chr15_all_filt_noout.prune.in --make-bed --pca --out 5_chr15_all_filt_noout
#10138 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 5_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 5_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 5_chr15_dropped_filt_noout
#9924 variants and 83 people pass filters and QC.

#############
#6. chr15 region 4 - contig15.1 14803486-15299732

echo "contig15.1 14803486 15299732" > region4.txt
sed -i 's/ /\t/g' region4.txt


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region4.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region4.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region4.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 6_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 6_chr15_all_filt_noout.prune.in --make-bed --pca --out 6_chr15_all_filt_noout
#6072 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 6_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region4.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 6_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 6_chr15_dropped_filt_noout
#5959 variants and 83 people pass filters and QC.

#############
#7. chr15 region 3

awk -F' ' '{if ($4=="3") print $0}' Dchry2.2_region_coordinates_simple.bed > region3.bed

awk '{print $1}' region3.bed | tail -n +2 > region3_chr.txt
awk '{print $2}' region3.bed | tail -n +2 > region3_start.txt
awk '{print $3}' region3.bed | tail -n +2 > region3_end.txt

paste -d '\t' region3_chr.txt region3_start.txt > region3_chr_start.txt
paste -d '\t' region3_chr_start.txt region3_end.txt > region3_targets.txt 


bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region3_targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region3.b.vcf.gz

bcftools view ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region3_targets.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 7_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 7_chr15_all_filt_noout.prune.in --make-bed --pca --out 7_chr15_all_filt_noout
#4559 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 7_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region3.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 7_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 7_chr15_dropped_filt_noout
#4470 variants and 83 people pass filters and QC.


#now move everything
mv * /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA 
mv *.vcf.gz ../../merged_vcfs/
mv *.tbi ../../merged_vcfs/

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/*.eigen* /Users/rishide-kayne/Dropbox/RishiMac2/Danaus/Wild90/PCAs/

#############
#8. chr15 region 1.1 - contig15.1	4035981	5322257

echo "contig15.1 4035981 5322257" > region1.1.txt
sed -i 's/ /\t/g' region1.1.txt


bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region1.1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.1.b.vcf.gz

bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.1.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 8_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 8_chr15_all_filt_noout.prune.in --make-bed --pca --out 8_chr15_all_filt_noout
#16519 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 8_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.1.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 8_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 8_chr15_dropped_filt_noout
#16091 variants and 83 people pass filters and QC.

#############
#9. chr15 region 1.1 - contig15.1	5323805	6220875

echo "contig15.1 5323805 6220875" > region1.2.txt
sed -i 's/ /\t/g' region1.2.txt


bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15.b.vcf.gz -T region1.2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.2.b.vcf.gz

bcftools view /data/martin/genomics/analyses/Danaus_popgen/Wild90/merged_vcfs/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15.b.vcf.gz -T region1.2.txt -Oz > ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz


plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 9_chr15_all_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 9_chr15_all_filt_noout.prune.in --make-bed --pca --out 9_chr15_all_filt_noout
#5695 variants and 90 people pass filters and QC.

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 9_chr15_dropped_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_nosmallcontigs_CHR15_region1.2.b.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 9_chr15_dropped_filt_noout.prune.in --make-bed --pca --out 9_chr15_dropped_filt_noout
#5541 variants and 83 people pass filters and QC.

mv * /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/
cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA 
mv *.vcf.gz ../../merged_vcfs/

scp qmaster:/data/martin/genomics/analyses/Danaus_popgen/Wild90/analysis/PCA/*.eigen* .

