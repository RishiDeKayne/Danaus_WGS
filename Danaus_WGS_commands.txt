#commands for ***

#check queue
qstat -f -u "*"

#1. Genotyping



########
#1. GENOTYPING
########

#make list of scaffolds
cut -f1 /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai > /data/martin/genomics/analyses/Danaus_mapping/scaf.list

#prepare list of bams
#need to add full filepath
cp Wild100list_90inds_bam.list Wild100list_90inds_full_filepath_bam.list

sed -i 's/^/\/data\/martin\/genomics\/analyses\/Danaus_mapping\//g' Wild100list_90inds_full_filepath_bam.list

#want 2 test sets - start with contig2.1 and the z which is contig1.1

sconda genomics_general

touch geno_test1_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list -r "${line}" | bcftools call -m -f GQ -O u | bgzip > /scratch/rdekayne/genotyping/"${line}".raw1.vcf.gz" >> geno_test1_1pop.txt
done

touch geno_test1_nohwe.txt

#this time we specify -G - to avoid any hwe filtering
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list -r "${line}" | bcftools call -m -f GQ --group-samples -O u | bgzip > /scratch/rdekayne/genotyping/"${line}".raw2.vcf.gz" >> geno_test1_nohwe.txt
done

head -n2 geno_test1_1pop.txt > test.geno_test1_1pop.txt

head -n2 geno_test1_nohwe.txt > test.geno_test1_nohwe.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno_test1_1pop.txt
parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno_test1_nohwe.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: geno_test1_1pop.txt

#############################################
#now trying indel re-alignment:
#############################################

#make conda env for gatk
conda create -n gatk
sconda gatk
conda install -c conda-forge parallel
conda install -c conda-forge openjdk

# bam output dir. /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned

#executible is: /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar

#e.g. https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists
#for bam in list want to run:
sed -i -e "s/\r//g" ../Wild100list_90inds_full_filepath_bam.list
sed -i -e "s/\r//g" ../Wild100list_90inds_bam.list

###FULL RUN
touch gatk_indel_realignment_creator_FULL_step1.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -o /scratch/rdekayne/gatk/realigner.intervals.${bam}.intervals" >> gatk_indel_realignment_creator_FULL_step1.txt
done

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: gatk_indel_realignment_creator_FULL_step1.txt

java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/SM17H07.EDSW200018975.2101.Dchry2.2.bwa.default.rmdup.bam -o /scratch/rdekayne/gatk/realigner.intervals.SM17H07.EDSW200018975.2101.Dchry2.2.bwa.default.rmdup.bam.intervals

touch run.last.sample.txt
echo "java -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T RealignerTargetCreator -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/SM17H01.302.200115.Dchry2.2.bwa.default.rmdup.bam_twosets.bam -o /scratch/rdekayne/gatk/realigner.intervals.SM17H01.302.200115.Dchry2.2.bwa.default.rmdup.bam_twosets.bam.intervals" >> run.last.sample.txt
parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 1 -l h=bigbang -b yes {}' :::: run.last.sample.txt

cp *.intervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals

touch gatk_indel_realignment_creator_FULL_step2.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/${bam} -targetIntervals /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/intervals/realigner.intervals.${bam}.intervals -o /scratch/rdekayne/gatk/realigned.${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned_confirmed/realigned.${bam}.done" >> gatk_indel_realignment_creator_FULL_step2.txt
done

ssh bigfoot
mkdir -p /scratch/rdekayne/gatk/

parallel -j 1 'qsub -cwd -N gatk_indel -V -pe smp64 3 -l h=bigfoot -b yes {}' :::: gatk_indel_realignment_creator_FULL_step2.txt

java -Xmx8G -jar /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/GenomeAnalysisTK-3.8-1-0-gf15c1c3ef/GenomeAnalysisTK.jar -T IndelRealigner -R /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa -I /data/martin/genomics/analyses/Danaus_mapping/SM17H07.EDSW200018975.2101.Dchry2.2.bwa.default.rmdup.bam -targetIntervals /scratch/rdekayne/gatk/realigner.intervals.SM17H07.EDSW200018975.2101.Dchry2.2.bwa.default.rmdup.bam.intervals -o /scratch/rdekayne/gatk/realigned.SM17H07.EDSW200018975.2101.Dchry2.2.bwa.default.rmdup.bam && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned_confirmed/realigned.SM17H07.EDSW200018975.2101.Dchry2.2.bwa.default.rmdup.bam.done

###assess bams with MOSDEPTH
#/data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth

ls *.bam > /scratch/rdekayne/mosdepth_danaus/bam_nofilepath.list

touch mosdepth_run.txt
cat /scratch/rdekayne/mosdepth_danaus/bam_nofilepath.list | while read bam
do
echo "mosdepth -n ${bam} /scratch/rdekayne/gatk/${bam} && touch /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/done_files/${bam}.done" >> mosdepth_run.txt
done

cp mosdepth_run.txt /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth

parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: mosdepth_run.txt

mkdir plot_dist
cd plot_dist/

python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt

scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/plot_dist/dist.html .

#../realigned.SM17H06.EDSW200018974-1a.220308.Dchry2.2.bwa.default.rmdup.bam.mosdepth.summary.txt:total  354020300       2628302217      7.42    0       2553
#../realigned.SM18W01.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam.mosdepth.summary.txt:total      354020300       34859745395     98.47   0       22276

mkdir low_high_indivs
mv ../*SM17H06* low_high_indivs
mv ../*SM18W01* low_high_indivs

python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt -o 88_dist.html

scp qmaster:/data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/plot_dist/88_dist.html .

#before genotyping want to downsample SM18W01 and move SM17H06 to rejected folder due to low coverage
ssh bigfoot
cd /scratch/rdekayne/gatk/

mkdir rejected_indivs
mv *SM17H06* rejected_indivs

sconda genomics_general
samtools view -s 0.30 -b realigned.SM18W01.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam > realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam

samtools index realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam

#now move old bam into rejected_indivs
mv realigned.SM18W01.UKDSW02200* rejected_indivs

#this leaves 90 individuals - 89 original and new subsampled SM18W01

#run mosdepth on this one sample - in /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth
echo "mosdepth -n realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam /scratch/rdekayne/gatk/realigned.SM18W01_downsampled30.UKDSW02200-C.220307.Dchry2.2.bwa.default.rmdup.bam" > subsampled_mosdepth.txt

parallel -j 1 'qsub -cwd -N mosdepth -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: subsampled_mosdepth.txt

#run mosdepth plot again for all 89 individuals
cd /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/mosdepth/plot_dist
python ../mosdepth/scripts/plot-dist.py ../*global.dist.txt -o 89_dist.html
#and download

#now to genotyping (bigfoot)
cd /scratch/rdekayne/genotyping

#prepare list of bams
#need to add full filepath
ls /scratch/rdekayne/gatk/*.bam > bam.list

wc -l bam.list
#90

sconda genomics_general

touch geno_realigned_1pop.txt
#will use default of one homogenous population for calling
cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /scratch/rdekayne/genotyping/bam.list -r "${line}" | bcftools call -m -f GQ -O u | bgzip > /scratch/rdekayne/genotyping/"${line}".realigned.raw.vcf.gz" >> geno_realigned_1pop.txt
done

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: geno_realigned_1pop.txt


#now merge the chromosome/contig vcfs:
cp /data/martin/genomics/analyses/Danaus_mapping/scaf.list . 
sed -i 's/$/.realigned.raw.vcf.gz/' /scratch/rdekayne/genotyping/scaf.list
mkdir -p /scratch/rdekayne/genotyping/combined_vcf && cd /scratch/rdekayne/genotyping/combined_vcf
bcftools concat -Ou -f /scratch/rdekayne/genotyping/scaf.list | bcftools sort -Oz -o /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output.vcf.gz

#filt all
bcftools filter -Oz ./Wild90_allchroms_output.vcf.gz -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz

bcftools filter -Oz ./Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz -e 'INFO/MAF > 0.05 | AN < 180' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz

##splitstree
bcftools +prune -l 0.2 -w 10000 /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz -Oz -o Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.vcf.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i /scratch/rdekayne/genotyping/popgen/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=5 max=50 -o ./Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.geno.gz

python /ceph/users/smartin/Research/genomics_general/distMat.py -g Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.geno.gz -f phased --windType cat -o Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.dist

#PCA
#make excl_list.txt listing individuals to get rid of:
SM17H01
SM17H02
SM17H03
SM17H04
SM17H05
SM17H07
AB19401
RB20110
SM20BE01

bcftools view -S ^excl_list.txt -o /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz

sconda PCA
plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 90_filt_noout

plink --vcf Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 90_filt_noout.prune.in --make-bed --pca --out 90_filt_noout

cp 90_filt_noout.eigenval 90_filt_noout.eigenvec /data/martin/genomics/analyses/Danaus_popgen/Wild90/

bcftools query -l Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.vcf.gz > indiv.list
cp indiv.list /data/martin/genomics/analyses/Danaus_popgen/Wild90/

#now do a pca with just chr15 loci:

cp Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf

bcftools view /scratch/rdekayne/genotyping/popgen/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs.vcf.gz --regions contig15.1 -Oz > /scratch/rdekayne/genotyping/popgen/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_CHR15.vcf.gz

sconda PCA
plink --vcf /scratch/rdekayne/genotyping/popgen/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_CHR15.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 90_chr15_filt_noout

plink --vcf /scratch/rdekayne/genotyping/popgen/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_dropped_indivs_CHR15.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 90_chr15_filt_noout.prune.in --make-bed --pca --out 90_chr15_filt_noout
#149882 variants remaining

cp 90_chr15*eigen* /data/martin/genomics/analyses/Danaus_popgen/Wild90/

bcftools view /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.vcf.gz --regions contig15.1 -Oz > /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15.vcf.gz

sconda PCA
plink --vcf /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out 90_chr15_nomissing_filt_noout

plink --vcf /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# --extract 90_chr15_nomissing_filt_noout.prune.in --make-bed --pca --out 90_chr15_nomissing_filt_noout

cp 90_chr15*eigen* /data/martin/genomics/analyses/Danaus_popgen/Wild90/

ls /data/martin/genomics/analyses/Danaus_popgen/Wild90/temporary_chr_vcfs/ > vcf_list.txt
cp vcf_list.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/temporary_chr_vcfs/

touch bcf_to_geno_conv.txt

cat /data/martin/genomics/analyses/Danaus_popgen/Wild90/temporary_chr_vcfs/vcf_list.txt | while read line
do
echo "scp /data/martin/genomics/analyses/Danaus_popgen/Wild90/temporary_chr_vcfs/"${line}" /scratch/rdekayne/genotyping/popgen/chr_genos/"${line}".bcf.gz && bcftools convert -Oz -o /scratch/rdekayne/genotyping/popgen/chr_genos/"${line}".vcf.gz /scratch/rdekayne/genotyping/popgen/chr_genos/"${line}".bcf.gz && rm -f /scratch/rdekayne/genotyping/popgen/chr_genos/"${line}".bcf.gz && python /scratch/rdekayne/genotyping/popgen/genomics_general/VCF_processing/parseVCF.py -i /scratch/rdekayne/genotyping/popgen/chr_genos/"${line}".vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o /scratch/rdekayne/genotyping/popgen/chr_genos/"${line}".geno.gz && touch /scratch/rdekayne/genotyping/popgen/chr_genos/done_files/"${line}".done" >> bcf_to_geno_conv.txt
done

cp geno_conv.txt /data/martin/genomics/analyses/Danaus_popgen/Wild90/temporary_chr_vcfs/

cd /data/martin/genomics/analyses/Danaus_popgen/Wild90/temporary_chr_vcfs/

parallel -j 1 'qsub -cwd -N convert -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: bcf_to_geno_conv.txt





######
Active
#####

#admixture
conda create -n admixture
sconda admixture
conda install -c bioconda admixture

mkdir -p /scratch/rdekayne/genotyping/popgen/admixture && cd /scratch/rdekayne/genotyping/popgen/admixture
sconda PCA

echo "contig15.1 chr1" >> chr_name_conv.txt
bcftools annotate --rename-chrs chr_name_conv.txt /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15.vcf.gz | bgzip > /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15_renamed.vcf.gz

VCF_FILE=/scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15_renamed.vcf.gz
plink --vcf $VCF_FILE --double-id --autosome-num 1 \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out admix_in

#Pruned 279162 variants from chromosome 1, leaving 151963.

# prune and create pca
plink --vcf $VCF_FILE --double-id --autosome-num 1 --set-missing-var-ids @:# \
--extract admix_in.prune.in \
--make-bed --pca --out admix_in

#151963 variants and 90 samples pass filters and QC.

admixture --cv=20 -j8 admix_in.bed 2 | tee log2_admix_in.out
CV error (K=2): 0.17235

admixture --cv=20 -j8 admix_in.bed 3 | tee log3_admix_in.out


touch admixture_run.txt
for K in {2..10}
do 
echo "admixture --cv=20 -j8 /scratch/rdekayne/genotyping/popgen/admixture/admix_in.bed ${K} | tee /scratch/rdekayne/genotyping/popgen/admixture/log${K}_admix_in.out" >> admixture_run.txt
done

parallel -j 1 'qsub -cwd -N convert -V -pe smp64 1 -l h=bigfoot -b yes {}' :::: admixture_run.txt



######
Active
#####
















plink --vcf /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15.vcf.gz --allow-extra-chr --out fast_struct_chr15_90


for K in {2..14}
do 
admixture --cv=20 -j8 all99_filt_noout.bed ${K} | tee log${K}_all99_filt_noout.out
done






python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30.vcf.gz --skipIndels --minQual 30 --gtf flag=DP min=7 max=50 -o /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30.geno.gz


python /ceph/users/smartin/Research/genomics_general/popgenWindows.py -w 100000 -m 10 -g ../Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing.LD_FILT.geno.gz -o ./all_Wild90.csv.gz -f phased -T 2 --analysis indHet popDist popFreq -p popA SM17H01,SM17H02,SM17H03,SM17H04,SM17H05,SM17H07




conda create -n faststructure
sconda faststructure
mamba install faststructure

#executible:
python /ceph/users/rdekayne/.conda/envs/faststructure/bin/structure.py

#faststructure
convert vcf (with no chr15 to bed file plus the .fam and .bim
https://rajanil.github.io/fastStructure/ 

sconda PCA
cd /scratch/rdekayne/genotyping/popgen/faststructure
plink --vcf /scratch/rdekayne/genotyping/combined_vcf/Wild90_allchroms_output_filt_mindepth7_minqual30_maf0.05_no_missing_CHR15.vcf.gz --allow-extra-chr --out fast_struct_chr15_90

sconda faststructure
python /ceph/users/rdekayne/.conda/envs/faststructure/bin/structure.py -K 3 --format=bed --input=fast_struct_chr15_90 --output=fast_struct_chr15_90_simp_out --full --seed=100 --prior=simple

python /ceph/users/rdekayne/.conda/envs/faststructure/bin/structure.py -K 4 --format=bed --input=fast_struct_chr15_90 --output=fast_struct_chr15_90_simp_out --full --seed=100 --prior=simple

#test best k
python /ceph/users/rdekayne/.conda/envs/faststructure/bin/chooseK.py --input=fast_struct_chr15_90_simp_out

#plot data
#copy distruct.py . and add:
#import matplotlib
#matplotlib.use('Agg')

python /ceph/users/rdekayne/.conda/envs/faststructure/bin/distruct.py -K 4 --input=fast_struct_chr15_90_simp_out --output=fast_struct_chr15_90_simp_out_distruct.svg



#get genome wide pi estimates
mkdir /scratch/rdekayne/genotyping/popgen/pi && cd /scratch/rdekayne/genotyping/popgen/pi
















##HERE##

#filter one chromosome
#raw
bcftools view -H contig31.1.raw1.vcf.gz | wc -l
4430099

#realigned
bcftools view -H contig31.1.realigned.raw.vcf.gz | wc -l
4430099

##pre-indel realignment
bcftools filter -Oz ./contig31.1.raw1.vcf.gz -e 'FORMAT/DP < 8 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.filt.vcf.gz

##post-indel realignment
bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 8 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt.vcf.gz

bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 7 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt7.vcf.gz

bcftools filter -Oz ../contig31.1.realigned.raw.vcf.gz -e 'FORMAT/DP < 9 | FORMAT/GQ < 30' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bcftools sort -Oz -o ./contig31.1.realigned.filt9.vcf.gz

bcftools view -H contig31.1.filt.vcf.gz | wc -l
4321554

bcftools view -H contig31.1.realigned.filt.vcf.gz | wc -l
4321531

##########
#Error test

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt.vcf.gz --skipIndels | bgzip > contig31.filt.geno.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt7.vcf.gz --skipIndels | bgzip > contig31.filt7.geno.gz

python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.realigned.filt9.vcf.gz --skipIndels | bgzip > contig31.filt9.geno.gz


python /ceph/users/smartin/Research/genomics_general/VCF_processing/parseVCF.py -i ./contig31.1.filt.vcf.gz --skipIndels | bgzip > contig31.filt.raw.geno.gz


python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts.output.csv

python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt7.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts7.output.csv

python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt9.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts9.output.csv


python /ceph/users/smartin/Research/genomics_general/countGenotypePatterns.py -i contig31.filt.raw.geno.gz -s IG19G114,SM19M056,AB19401 -o contig31.counts.raw.output.csv

conda create -n PCA
sconda PCA
conda install -c bioconda plink

#test on one chromosome:
#contig31.1.realigned.filt7.vcf.gz

bcftools filter -Oz ./contig31.1.realigned.filt7.vcf.gz -e 'INFO/MAF > 0.05 | AN < 90' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./contig31.1.realigned.filt7.test.vcf.gz

bcftools view -H contig31.1.realigned.filt7.test.vcf.gz | wc -l

grep "SM17H" indiv.list > excl.list
grep "AB19" indiv.list >> excl.list
grep "RB20110" indiv.list >> excl.list
grep "SM20BE01" indiv.list >> excl.list

bcftools view -S ^excl.list -o contig31.1.realigned.filt7.test_droppedindivs.vcf.gz contig31.1.realigned.filt7.test.vcf.gz


plink --vcf contig31.1.realigned.filt7.test_droppedindivs.vcf.gz --double-id --allow-extra-chr \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out test_filt_noout

# prune and create pca
plink --vcf contig31.1.realigned.filt7.test_droppedindivs.vcf.gz --double-id --allow-extra-chr --set-missing-var-ids @:# \
--extract test_filt_noout.prune.in \
--make-bed --pca --out test_filt_noout

scp *.eigen* /data/martin/genomics/analyses/Danaus_popgen/Wild90/

bcftools filter -Oz ./Wild90_allchroms_output_filt_mindepth8_minqual30.vc.gz -e 'INFO/MAF > 0.05 | AN < 90' | bcftools view -m2 -M2 -v snps | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth8_minqual30_maf0.05_missing90.vcf.gz

bcftools view -m2 -M2 -v snps Wild90_allchroms_output_filt_mindepth8_minqual30_maf0.05_missing90.vc.gz | bcftools sort -Oz -o ./Wild90_allchroms_output_filt_mindepth8_minqual30_maf0.05_missing90_biallelic.vcf.gz

plink --vcf Wild90_allchroms_output_filt_mindepth8_minqual30_nomissing.vc.gz --double-id --allow-extra-chr \
--set-missing-var-ids @:# \
--indep-pairwise 50 10 0.1 --out all90_filt_noout

# prune and create pca
plink --vcf Wild90_allchroms_output_filt_mindepth8_minqual30_nomissing.vc.gz --double-id --allow-extra-chr --set-missing-var-ids @:# \
--extract all90_filt_noout.prune.in \
--make-bed --pca --out all90_filt_noout




touch move_and_delete_scratch_bams.txt
cat /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_bam.list | while read bam
do
echo "rsync /scratch/rdekayne/gatk/realigned.${bam} /data/martin/genomics/analyses/Danaus_mapping/Wild90_realigned/realigned.${bam} && rm /scratch/rdekayne/gatk/realigned.${bam}" >> move_and_delete_scratch_bams.txt



###Stairplot
#stairplot
qstat -f -u "*"

conda create -n angsd 
sconda angsd
conda install -c bioconda angsd=0.921
conda install -c conda-forge parallel

ls /data/martin/genomics/analyses/Danaus_mapping/SM16S*.Dchry2.2.*.bam > bam.list

cp /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa .
cp /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa.fai .

cut -f1 Dchry2.2.fa.fai | grep -v "contig0." | grep -v "contig15.1" > /data/martin/genomics/analyses/Danaus_popgen/StHelena_project/angsd/chrom.list

cat chrom.list | while read line
do
	echo 'angsd -gl 2 -dosaf 1 -bam /scratch/rdekayne/angsd/bam.list -ref /scratch/rdekayne/angsd/Dchry2.2.fa -anc /scratch/rdekayne/angsd/Dchry2.2.fa -nThreads 1 -r '${line}' -baq 1 -C 50 -minMapQ 1 -P 30 -minQ 20 -out /scratch/rdekayne/angsd/output.'${line}'.baq1MQ1Q20GL2' >> angsd_run.txt
done

parallel -j 1 'qsub -cwd -N angsd -V -pe smp64 1 -l h=bigbang -b yes {}' :::: angsd_run.txt

#grep "Number of sites retained after filtering" *.e* | wc -l
#40

#grep "Number of sites retained after filtering" *.e* | cut -d':' -f3 > lengths.txt
#cat lengths.txt | awk '{SUM+=$1}END{print SUM}'
#310150036

#check output makes sense
realSFS print output.contig13.1.baq1MQ1Q20GL2.saf.idx | head

realSFS cat -outnames mergedALL *.idx

realSFS mergedALL.saf.idx -P 30 -maxIter 100 -bootstrap 20 > output.mergedALL.baq1MQ1Q20GL2.BS20.sfs

realSFS merged.saf.idx -P 60 -maxIter 100 -bootstrap 20 -fold 1 > output.merged.fodlded.baq1MQ1Q20GL2.BS20.sfs

#fold this manually with simon's R function

###OUTPUT
	-> Only read nSites: 0 will therefore prepare next chromosome (or exit)

	-> NB NB output is no longer log probs of the frequency spectrum!
	-> Output is now simply the expected values! 
	-> You can convert to the old format simply with log(norm(x))


###################

touch genotype_run.txt

cat /data/martin/genomics/analyses/Danaus_mapping/scaf.list | while read line
do
echo "bcftools mpileup -O u -d 250 --skip-indels -f /data/martin/genomics/analyses/Danaus_genome/Dchry2/Dchry2.2.fa --annotate FORMAT/DP --bam-list /data/martin/genomics/analyses/Danaus_mapping/Wild100list_90inds_full_filepath_bam.list -r "${line}" | bcftools call -m -f GQ -O u | bcftools filter -e 'FORMAT/DP < 5 | FORMAT/GQ < 20' --set-GTs . -O u | bcftools filter -e 'AN < 2' | bgzip > /scratch/rdekayne/genotyping/"${line}".vcf.gz" >> genotype_run.txt
done

#parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: genotype_run.txt

head -n2 genotype_run.txt > test.geno.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno.txt

head -n2 genotype_run.txt > test.geno.txt

parallel -j 1 'qsub -cwd -N bcftools -V -pe smp64 1 -l h=bigbang -b yes {}' :::: test.geno.txt


